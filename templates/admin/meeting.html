<!-- templates/admin/meeting.html -->
{% extends "admin/index.html" %}

{% block title %}Meetings â€” Student Hub{% endblock %}

{% block head %}
  <!-- flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    :root{
      --bg:#f7faf9; --panel:#fff; --muted:#6b7280; --accent:#16a34a; --card-border:#e6eef0;
    }
    body { background:var(--bg); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:#0f172a; }

    /* ---------- Top bar ---------- */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 1200;
      background: var(--panel);
      border-bottom: 1px solid var(--card-border);
      padding: 14px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      box-shadow: 0 2px 8px rgba(12,18,30,0.02);
    }
    .topbar-left { display:flex; align-items:center; gap:12px; }
    .meetings-title { font-size:22px; font-weight:800; margin:0; }
    .muted-small { color:var(--muted); font-size:13px; margin-top:2px; }

    /* keep small caption below title when in left block */
    .title-block { display:flex; flex-direction:column; }

    .meet-controls {
      display:flex;
      align-items:center;
      gap:12px;
    }

    .search-inline { display:flex; align-items:center; gap:8px; background:var(--panel); border:1px solid var(--card-border); border-radius:10px; padding:8px 12px; }
    .search-inline input { border:0; outline:0; background:transparent; color:var(--muted); width:260px; font-size:14px; }

    .btn { padding:8px 12px; border-radius:8px; cursor:pointer; border:0; background:var(--accent); color:#fff; font-weight:700; }
    .btn.secondary { background:#fff; color:#111; border:1px solid var(--card-border); }

    .stat-row { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:20px; }
    .stat-tile { background:var(--panel); border:1px solid var(--card-border); border-radius:10px; padding:14px; display:flex; flex-direction:column; gap:6px; }
    .stat-label { color:var(--muted); font-size:13px; }
    .stat-number { font-weight:800; color:var(--accent); font-size:18px; }

    .meet-body { display:grid; grid-template-columns:1fr 320px; gap:20px; align-items:start; padding:18px 0; }
    .meet-list-panel { background:var(--panel); border:1px solid var(--card-border); border-radius:10px; padding:16px; min-height:220px; }
    .meeting-card { border:1px solid var(--card-border); border-radius:8px; background:#fff; padding:12px; display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px; }
    .meeting-title { font-weight:700; font-size:15px; }
    .meeting-purpose { color:var(--muted); font-size:13px; margin-top:6px; }
    .meeting-meta { font-size:13px; color:var(--muted); margin-top:6px; }
    .tag { background:#f0fdf4; color:var(--accent); border-radius:999px; padding:4px 8px; font-size:12px; margin-right:6px; display:inline-block; }
    .join-btn { background:var(--accent); color:#fff; padding:6px 10px; border-radius:8px; text-decoration:none; font-weight:700; }

    /* modal */
    #modal { display:none; position:fixed; inset:0; background:rgba(10,15,25,0.38); align-items:center; justify-content:center; z-index:1400; padding:18px; }
    .dialog { width:min(820px,96%); background:var(--panel); border-radius:12px; border:1px solid var(--card-border); box-shadow:0 12px 40px rgba(12,18,30,0.06); max-height:calc(100vh - 64px); display:flex; flex-direction:column; overflow:hidden; }
    .dialog-header { padding:14px 18px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(0,0,0,0.03); }
    .dialog-header h3 { margin:0; font-size:18px; font-weight:800; }
    .close-x { background:transparent; border:0; font-size:18px; color:var(--muted); cursor:pointer; }

    .dialog-body { padding:16px 18px; overflow:auto; -webkit-overflow-scrolling:touch; }

    .field { position:relative; margin-top:12px; }
    .input, textarea, select, select[multiple] { width:100%; box-sizing:border-box; padding:12px 12px; border-radius:8px; border:1px solid var(--card-border); background:#fff; font-size:14px; color:#0f172a; }
    textarea { min-height:80px; resize:vertical; padding-top:18px; }

    .floating-label { position:absolute; left:12px; top:12px; font-size:13px; color:var(--muted); background:transparent; pointer-events:none; padding:0 6px; transition:transform .12s ease, font-size .12s ease, top .12s ease, color .12s ease; }
    .input:focus + .floating-label, .input:not(:placeholder-shown) + .floating-label, textarea:focus + .floating-label, textarea:not(:placeholder-shown) + .floating-label, select:focus + .floating-label, .has-value > .floating-label { transform: translateY(-130%); top:6px; font-size:12px; color:var(--accent); background:var(--panel); }

    .virtual-row { display:flex; align-items:center; gap:8px; margin-top:8px; }
    .virtual-row input { width:16px; height:16px; accent-color:var(--accent); }

    .dialog-footer { display:flex; justify-content:flex-end; gap:10px; padding:12px 18px; border-top:1px solid rgba(0,0,0,0.03); background:linear-gradient(180deg, rgba(255,255,255,0), rgba(255,255,255,1)); }

    .muted-note { color:var(--muted); font-size:13px; margin-top:8px; }

    /* datetime button (icon) */
    .field.datetime-field { position:relative; }
    .field.datetime-field .input { padding-right:44px; }
    .datetime-btn {
      position:absolute; right:10px; top:50%; transform:translateY(-50%);
      width:34px; height:34px; border-radius:8px; border:1px solid var(--card-border);
      background:#fff; display:grid; place-items:center; cursor:pointer; box-shadow: 0 2px 6px rgba(12,18,30,0.06);
      color:var(--muted); transition: background .12s ease, color .12s ease, transform .06s ease;
    }
    .datetime-btn:hover { background:#f3f6f5; color:var(--accent); transform: translateY(-50%) scale(1.03); }

    @media (max-width:920px) {
      .meet-body { grid-template-columns: 1fr; }
      .stat-row { grid-template-columns: repeat(2,1fr); }
      .search-inline input { width:180px; }
      .topbar { padding:12px; gap:8px; }
    }
    @media (max-width:720px) { .search-inline input { width:140px; } .dialog { width: calc(100% - 28px); } }
    body.modal-open { overflow:hidden; }
  </style>
{% endblock %}

{% block body %}
  <!-- Top bar: meetings title + search + schedule button -->
  <header class="topbar" role="banner">
    <div class="topbar-left">
      <div class="title-block">
        <div class="meetings-title">Meetings</div>
        <div class="muted-small">Schedule and manage your meetings</div>
      </div>
    </div>

    <div class="meet-controls" role="search">
      <div class="search-inline" aria-label="Search meetings">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity:0.6" aria-hidden="true"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.5"/></svg>
        <input id="searchInput" placeholder="Search meetings..." aria-label="Search meetings" />
      </div>

      <button id="openModalBtn" class="btn">+ Schedule Meeting</button>
    </div>
  </header>

  <div class="meetings-page" style="padding: 18px 20px 36px;">
    <div class="stat-row">
      <div class="stat-tile"><div class="stat-label">Not Started</div><div class="stat-number" id="statNotStarted">0</div></div>
      <div class="stat-tile"><div class="stat-label">This Week</div><div class="stat-number" id="statThisWeek">0</div></div>
      <div class="stat-tile"><div class="stat-label">Projects</div><div class="stat-number" id="statProjects">0</div></div>
      <div class="stat-tile"><div class="stat-label">Virtual</div><div class="stat-number" id="statVirtual">0</div></div>
    </div>

    <div class="meet-body">
      <div class="meet-list-panel">
        <div id="meetingList" style="min-height:200px;">
          <div style="padding:18px;color:var(--muted)">No meetings found.</div>
        </div>
      </div>

      <aside style="padding:16px;border-radius:10px;background:var(--panel);border:1px solid var(--card-border);">
        <h4 style="margin:0 0 8px 0;">Next Up</h4>
        <div id="nextUp" class="muted-note">No upcoming meetings</div>
      </aside>
    </div>
  </div>

  <!-- modal -->
  <div id="modal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="dialog-header">
        <h3 id="modalTitle">Schedule Meeting</h3>
        <button class="close-x" id="modalCloseBtn" aria-label="Close">âœ•</button>
      </div>

      <div class="dialog-body">
        <form id="meetingForm" autocomplete="off">
          <input type="hidden" id="editingId" value="" />

          <div class="field">
            <input id="title" class="input" type="text" placeholder=" " required />
            <label class="floating-label">Title</label>
          </div>

          <div style="display:flex;gap:12px;">
            <div style="flex:1" class="field">
              <select id="type" class="input">
                <option value="project">Project</option>
                <option value="office hours">Office Hours</option>
                <option value="advising">Advising</option>
                <option value="study group">Study Group</option>
              </select>
              <label class="floating-label">Type</label>
            </div>

            <!-- FLATPICKR: this visible input is enhanced by flatpickr -->
            <div style="width:240px" class="field datetime-field">
              <input id="datetime_fp" class="input" type="text" placeholder=" " aria-label="Date and time" />
              <label class="floating-label">Date &amp; Time</label>

              <button type="button" id="datetimeBtn" class="datetime-btn" aria-label="Open date and time picker">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M3 8h18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  <rect x="3" y="5" width="18" height="16" rx="2" stroke="currentColor" stroke-width="1.2"/>
                  <path d="M16 3v4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  <path d="M8 3v4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
          </div>

          <div class="field">
            <textarea id="purpose" class="input" placeholder=" "></textarea>
            <label class="floating-label">Purpose</label>
          </div>

          <div style="display:flex;gap:12px;align-items:flex-start;">
            <div style="flex:1" class="field">
              <input id="location" class="input" type="text" placeholder=" " />
              <label class="floating-label">Location</label>
            </div>

            <div style="width:120px;">
              <div class="virtual-row">
                <input type="checkbox" id="isVirtual" />
                <label for="isVirtual" style="font-weight:700;color:#0f172a">Virtual</label>
              </div>
            </div>
          </div>

          <div id="meetLinkWrapper" style="display:none" class="field">
            <input id="meetLink" class="input" type="url" placeholder=" " />
            <label class="floating-label">Meet link (optional)</label>
            <div class="muted-note">Leave blank to save without a join link.</div>
          </div>

          <div class="field">
            <select id="students" class="input" multiple size="6"></select>
            <label class="floating-label">Students</label>
          </div>
        </form>
      </div>

      <div class="dialog-footer">
        <button id="cancelBtn" class="btn secondary">Cancel</button>
        <button id="saveBtn" class="btn">Add</button>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <!-- flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // helper: show toast
    function showToast(msg, type='info') {
      const c = document.getElementById('toast-container') || (function(){ const d=document.createElement('div'); d.id='toast-container'; d.style.position='fixed'; d.style.right='18px'; d.style.top='18px'; d.style.zIndex=1500; document.body.appendChild(d); return d; })();
      const el = document.createElement('div');
      el.style.padding='10px 12px'; el.style.borderRadius='8px'; el.style.color='#fff'; el.style.fontWeight=700; el.style.marginTop='8px';
      el.style.background = type==='error' ? '#ef4444' : (type==='success' ? '#16a34a' : '#0ea5a1');
      el.textContent = msg;
      c.appendChild(el);
      setTimeout(()=> el.remove(), 3200);
    }

    const $ = s => document.querySelector(s);
    let meetings = [], students = [], searchTerm='';

    async function fetchJSON(url, opts={}) {
      const o = Object.assign({ credentials:'same-origin' }, opts);
      const r = await fetch(url, o);
      if (r.status === 401) { showToast('Session expired â€” please log in','error'); setTimeout(()=> location.href='/login',900); throw new Error('Unauthorized'); }
      const txt = await r.text();
      try { return JSON.parse(txt); } catch(e) { return txt; }
    }

    async function fetchStudents(){
      try {
        const data = await fetchJSON('/api/students', { method:'GET' });
        students = Array.isArray(data) ? data : (data.students || []);
        $('#students').innerHTML = students.map(s=>`<option>${s.name}</option>`).join('');
        tuneFloatingLabels();
      } catch(e){ console.error(e); }
    }

    async function fetchMeetings(){
      try {
        const data = await fetchJSON('/api/meetings', { method:'GET' });
        meetings = Array.isArray(data) ? data : (data.meetings || []);
        render();
      } catch(e){ console.error(e); showToast('Failed to load meetings','error'); }
    }

    async function addMeeting(payload){
      return fetchJSON('/api/meetings', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    }
    async function patchMeeting(id,payload){ return fetchJSON(`/api/meetings/${id}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }); }
    async function deleteMeeting(id){ await fetchJSON(`/api/meetings/${id}`, { method:'DELETE' }); showToast('Meeting deleted','success'); await fetchMeetings(); }
    async function updateStatus(id,status){ await fetchJSON(`/api/meetings/${id}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ status }) }); showToast('Status updated','success'); await fetchMeetings(); }

    function formatDate(dt){
      const d=new Date(dt);
      return d.toLocaleString([], { weekday:'short', month:'short', day:'numeric', hour:'numeric', minute:'2-digit' });
    }
    function isThisWeek(dt){
      const d=new Date(dt), now=new Date(); const start=new Date(now); start.setDate(now.getDate()-now.getDay()+1); const end=new Date(start); end.setDate(start.getDate()+6); return d>=start && d<=end;
    }
    function isUpcoming(dt){ return new Date(dt) > new Date(); }

    function render(){
      const filtered = meetings.filter(m => (m.title+m.purpose+(m.type||'')).toLowerCase().includes(searchTerm));
      const list = $('#meetingList');
      if (!filtered.length) list.innerHTML = '<div style="padding:18px;color:var(--muted)">No meetings found.</div>'; else {
        list.innerHTML = filtered.map(m=>{
          const isVirtual = !!(m.meetLink && m.meetLink.trim());
          const tags = `${m.type ? `<span class="tag">${m.type}</span>` : ''} ${isVirtual?'<span class="tag">Virtual</span>':''}`;
          const join = isVirtual ? `<a class="join-btn" href="${m.meetLink}" target="_blank">Join</a>` : '';
          return `<div class="meeting-card" data-id="${m.id}">
            <div style="max-width:68%">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div class="meeting-title">${m.title}</div>
                <div style="display:flex;gap:8px"><button class="icon-btn edit-btn" title="Edit" style="border:0;background:transparent;cursor:pointer;color:var(--muted)">âœŽ</button></div>
              </div>
              <div style="margin-top:8px">${tags}</div>
              <div class="meeting-purpose">${m.purpose||''}</div>
              <div class="meeting-meta">${formatDate(m.datetime)} â€¢ ${m.location||''}</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
              <select class="status-select" style="padding:6px;border-radius:8px;border:1px solid var(--card-border)">
                ${['Not Started','In Progress','Completed','Cancelled'].map(s=>`<option ${m.status===s?'selected':''}>${s}</option>`).join('')}
              </select>
              ${join}
              <button data-action="delete" title="Delete" style="border:0;background:transparent;cursor:pointer;color:var(--muted)">ðŸ—‘</button>
            </div>
          </div>`;
        }).join('');
      }

      // stats
      $('#statNotStarted').textContent = meetings.filter(m=>m.status==='Not Started').length;
      $('#statProjects').textContent = meetings.filter(m=>m.type==='project').length;
      $('#statThisWeek').textContent = meetings.filter(m=>isThisWeek(m.datetime)).length;
      $('#statVirtual').textContent = meetings.filter(m=>m.meetLink && m.meetLink.trim()).length;

      const next = meetings.filter(m=>isUpcoming(m.datetime)).sort((a,b)=>new Date(a.datetime)-new Date(b.datetime)).slice(0,3);
      $('#nextUp').innerHTML = next.length ? next.map(m=>`<div style="margin-bottom:8px"><strong>${m.title}</strong><div style="color:var(--muted);font-size:13px">${formatDate(m.datetime)}</div></div>`).join('') : '<div style="color:var(--muted)">No upcoming meetings</div>';
    }

    // ---------- flatpickr init ----------
    let fp = null;
    function initFlatpickr() {
      const el = document.getElementById('datetime_fp');
      if (!el) return;

      if (fp && fp.destroy) fp.destroy();

      fp = flatpickr(el, {
        enableTime: true,
        time_24hr: false,
        minuteIncrement: 5,
        altInput: false,
        dateFormat: "Y-m-d\\TH:i",   // produce ISO with 'T'
        defaultDate: null,
        onReady: function(selectedDates, dateStr, instance){
          // add "Now" quick button to calendar
          const btnNow = document.createElement('button');
          btnNow.type = 'button';
          btnNow.textContent = 'Now';
          btnNow.className = 'btn';
          btnNow.style.margin = '6px';
          btnNow.style.fontSize = '13px';
          btnNow.addEventListener('click', function(){
            instance.setDate(new Date(), true, "Y-m-d\\TH:i");
          });
          instance.calendarContainer.appendChild(btnNow);
        },
        onChange: function(selectedDates, dateStr, instance){
          tuneFloatingLabels();
        }
      });

      // hook calendar button
      const dtBtn = document.getElementById('datetimeBtn');
      if (dtBtn) {
        dtBtn.addEventListener('click', function(ev){
          ev.preventDefault();
          try { fp.open(); } catch(err) {}
          try { el.focus(); } catch(err) {}
        });
      }

      // make input open on focus
      el.addEventListener('focus', () => { try{ if (fp && !fp.isOpen) fp.open(); } catch(e){} });
    }

    // ---------- modal handling ----------
    function openModal(edit=false){
      const modal = $('#modal'); modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); document.body.classList.add('modal-open');
      if (!edit) {
        $('#modalTitle').textContent='Schedule Meeting'; $('#saveBtn').textContent='Add'; $('#editingId').value=''; $('#meetingForm').reset(); $('#meetLinkWrapper').style.display='none';
        if (fp) fp.clear();
      }
      tuneFloatingLabels();
      setTimeout(()=> $('#title').focus(), 50);
    }
    function closeModal(){ const modal = $('#modal'); modal.style.display='none'; modal.setAttribute('aria-hidden','true'); document.body.classList.remove('modal-open'); $('#meetingForm').reset(); $('#editingId').value=''; $('#meetLinkWrapper').style.display='none'; if (fp) fp.clear(); }

    function fillForm(meeting){
      $('#modalTitle').textContent='Edit Meeting'; $('#saveBtn').textContent='Save'; $('#editingId').value = meeting.id;
      $('#title').value = meeting.title || ''; $('#type').value = meeting.type || 'project'; $('#purpose').value = meeting.purpose || '';
      if (meeting.datetime) {
        if (fp) fp.setDate(new Date(meeting.datetime), true, "Y-m-d\\TH:i");
        else $('#datetime_fp').value = meeting.datetime;
      }
      $('#location').value = meeting.location || ''; $('#meetLink').value = meeting.meetLink || ''; $('#isVirtual').checked = !!(meeting.meetLink && meeting.meetLink.trim());
      $('#meetLinkWrapper').style.display = $('#isVirtual').checked ? 'block' : 'none';
      Array.from($('#students').options).forEach(o=>o.selected=false);
      if (meeting.attendees && meeting.attendees.length){
        meeting.attendees.forEach(a=>{ const opt = Array.from($('#students').options).find(o=>o.value===a.name); if (opt) opt.selected=true; });
      }
      tuneFloatingLabels();
    }

    function tuneFloatingLabels(){
      document.querySelectorAll('.field').forEach(f=>{
        const input = f.querySelector('.input') || f.querySelector('input') || f.querySelector('textarea') || f.querySelector('select');
        if (!input) return;
        if ((input.value && String(input.value).trim().length) || (input.selectedOptions && input.selectedOptions.length)) f.classList.add('has-value'); else f.classList.remove('has-value');
      });
    }

    // ---------- wiring ----------
    document.addEventListener('DOMContentLoaded', async ()=>{
      initFlatpickr();
      await fetchStudents();
      await fetchMeetings();

      $('#openModalBtn').onclick = ()=> openModal(false);
      $('#cancelBtn').onclick = closeModal;
      $('#modalCloseBtn').onclick = closeModal;
      $('#isVirtual').addEventListener('change', e=> { $('#meetLinkWrapper').style.display = e.target.checked ? 'block' : 'none'; });
      $('#modal').addEventListener('click', e=> { if (e.target === $('#modal')) closeModal(); });

      $('#saveBtn').addEventListener('click', async ()=>{
        const editingId = $('#editingId').value;
        const title = $('#title').value.trim();
        const type = $('#type').value;
        const purpose = $('#purpose').value.trim();
        const datetime = document.getElementById('datetime_fp').value; // ISO 'T' from fp
        const location = $('#location').value.trim();
        const meetLink = $('#meetLink').value.trim();
        const attendees = Array.from($('#students').selectedOptions).map(o=>({name:o.value}));

        if (!title || !datetime) { showToast('Title and date/time required','error'); return; }
        if (meetLink && !/^https?:\/\//i.test(meetLink)){ showToast('Meet link should start with http:// or https://','error'); return; }

        const payload = { title, type, purpose, datetime, location, attendees };
        if (meetLink) payload.meetLink = meetLink;

        const btn = $('#saveBtn'); btn.disabled = true; btn.textContent = editingId ? 'Saving...' : 'Adding...';
        try {
          if (!editingId) {
            const res = await addMeeting(payload);
            if (!res || res.success===false) { showToast(res && res.message ? res.message : 'Failed to create','error'); return; }
            showToast('Meeting created','success');
          } else {
            const res = await patchMeeting(editingId, payload);
            if (!res || res.success===false) { showToast(res && res.message ? res.message : 'Failed to update','error'); return; }
            showToast('Meeting updated','success');
          }
        } catch(err){ console.error(err); showToast('Server error','error'); }
        finally { btn.disabled=false; btn.textContent = editingId ? 'Save' : 'Add'; }

        closeModal();
        await fetchMeetings();
      });

      $('#meetingForm').addEventListener('submit', e=>{ e.preventDefault(); $('#saveBtn').click(); });

      $('#meetingList').addEventListener('click', (e)=>{
        const del = e.target.closest('[data-action="delete"]'); if (del){ const id = del.closest('.meeting-card').dataset.id; deleteMeeting(id); return; }
        const edit = e.target.closest('.edit-btn'); if (edit){ const id = edit.closest('.meeting-card').dataset.id; const mt = meetings.find(m=>String(m.id)===String(id)); if (mt){ fillForm(mt); openModal(true); } }
      });

      $('#meetingList').addEventListener('change', (e)=>{ if (!e.target.classList.contains('status-select')) return; const id = e.target.closest('.meeting-card').dataset.id; updateStatus(id, e.target.value); });

      document.addEventListener('input', tuneFloatingLabels); document.addEventListener('change', tuneFloatingLabels);
      $('#searchInput').addEventListener('input', e=>{ searchTerm = e.target.value.toLowerCase(); render(); });
    });
  </script>
{% endblock %}
