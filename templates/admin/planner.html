{% extends "admin/index.html" %}

{% block title %}Planner â€” Student Hub{% endblock %}

{% block head %}
  <!-- flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <!-- shared UI styles (keeps tokens centralized) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/ui-common.css') }}">
  <style>
    /* Planner-specific styles */
    :root{
      --planner-accent: #0ea5e9;
      --planner-accent-2: #10b981;
      --accent-2: #f97316;
      --card-gap: 18px;
      --muted: #64748b;
      --white: #ffffff;
      --gray-200: #e6edf3;
      --gray-600: #6b7280;
      --shadow-sm: 0 6px 18px rgba(12,18,30,0.04);
    }

    .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    /* Planner layout */
    .planner-page{ display:flex; flex-direction:column; gap:16px; }
    .page-title { font-size:22px; font-weight:900; color:#0f172a; margin:0; }

    /* Updated grid ratio to 3:1 */
    .main-grid{ display:grid; grid-template-columns: 3fr 1fr; gap:var(--card-gap); margin-top:6px; align-items:start; }
    @media(max-width:1000px){ .main-grid{ grid-template-columns:1fr } }

    .panel{ padding:24px; border-radius:12px; background:var(--white); border:1px solid var(--gray-200); box-shadow:var(--shadow-sm); overflow:visible; min-height:calc(100vh - 280px); }

    /* Topbar styling to match image */
    .site-topbar { 
      padding: 20px 24px; 
      border-radius: 12px; 
      background: var(--white); 
      border: 1px solid var(--gray-200); 
      box-shadow: var(--shadow-sm); 
    }
    .topbar-content {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
    }
    .topbar-left {
      display: flex;
      flex-direction: column;
      gap: 14px;
      flex: 1;
    }
    .topbar-title-section {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .muted-note {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }
    .topbar-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .topbar-right {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* Stat tiles styling */
    .stat-tile {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 18px;
      border-radius: 10px;
      border: 1px solid var(--gray-200);
      background: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 110px;
    }
    .stat-tile:hover {
      background: #f9fafb;
      border-color: var(--planner-accent-2);
      transform: translateY(-2px);
    }
    .stat-label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
      text-align: center;
      margin-bottom: 4px;
    }
    .stat-number {
      font-size: 24px;
      font-weight: 900;
      color: var(--planner-accent-2);
    }

    /* Tablist style segmented control - cleaner look */
    .seg{
      position:relative;
      background:#ffffff;
      border-radius:10px;
      display:inline-flex;
      gap:4px;
      padding:6px; 
      align-items:center;
      border:1px solid var(--gray-200);
      box-shadow: 0 4px 12px rgba(12,18,30,0.03);
      outline: none;
    }
    .seg:focus-within { outline: none; }

    /* Cleaner thumb without visible background when inactive */
    .seg .thumb{
      position:absolute;
      left:6px;
      top:6px;
      bottom:6px;
      background: #10B981;
      border-radius:8px;
      transform:translateX(0);
      transition: transform .25s cubic-bezier(.4,.0,.2,1), width .2s ease, opacity .2s ease;
      box-shadow: 0 2px 8px rgba(16,185,129,0.25);
      z-index:1;
      pointer-events:none;
      opacity:1;
      will-change: transform, width;
    }

    .seg button{
      position:relative;
      z-index:2;
      background:transparent;
      border-radius:8px;
      border:0;
      padding:8px 16px;
      font-weight:700;
      color:#6b7280;
      cursor:pointer;
      transition: color .2s ease, transform .15s ease;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:14px;
      min-width:80px;
      text-align:center;
      justify-content:center;
    }

    .seg button.active{
      color:#ffffff !important;
      font-weight:800;
      z-index:3;
    }

    .seg button:hover:not(.active) {
      color:#374151;
    }

    .seg button:focus { outline: none; box-shadow: none; }
    .seg button:focus-visible {
      outline: 2px solid rgba(16,185,129,0.4);
      outline-offset: 2px;
      border-radius: 8px;
      z-index:4;
    }

    @media(max-width:640px){
      .seg { padding: 5px; gap: 3px; }
      .seg .thumb { top:5px; bottom:5px; left:5px; }
      .seg button { padding:7px 12px; font-size:13px; min-width:70px; }
    }

    /* Larger, more readable font sizes */
    .search-inline { display:flex;align-items:center;gap:8px;border-radius:10px;padding:8px 12px;border:1px solid var(--gray-200);background:var(--white);font-size:15px; }
    .task-card{ display:flex; gap:14px; align-items:stretch; border-radius:12px; padding:20px; border:1px solid #eef1f6; background:linear-gradient(180deg,#fff,#fff); margin-bottom:18px; font-size:16px; }
    .timeline-entry{ display:flex; gap:14px; align-items:flex-start; background:linear-gradient(180deg,#fff,#fff); border-radius:10px; padding:18px; border:1px solid #f1f3f5; font-size:16px; margin-bottom:14px; }
    .badge{ display:inline-block; padding:7px 10px; border-radius:999px; font-weight:800; font-size:13px; border:1px solid rgba(0,0,0,0.04) }
    .priority-high{ background:#fff7f7; color:#b91c1c; border-color:#fecaca; }
    .priority-medium{ background:#fff7ed; color:#c2410c; border-color:#fed7aa; }
    .priority-low{ background:#f0fdf4; color:#065f46; border-color:#bbf7d0; }
    .tag{ display:inline-block; padding:7px 10px; border-radius:8px; background:#f3f4f6; color:var(--gray-700); font-weight:700; font-size:13px; margin-right:6px }
    .tag.secondary{ background:#eef2ff; color:#4f46e5 }

    /* sort control styling */
    .controls-row{ display:flex; align-items:center; gap:8px; }
    #sortSel, #statsSortSel { width:120px; padding:8px 12px; border-radius:8px; border:1px solid var(--gray-200); background:var(--white); color:#0f172a; font-weight:700; font-size:13px }
    #sortSel option, #statsSortSel option{ color:#0f172a }
    .sort-label{ font-weight:700;color:var(--gray-600);font-size:14px;margin-right:6px }

    @media(max-width:640px){
      #sortSel, #statsSortSel{ width:100%; }
      .controls-row{ width:100%; justify-content:flex-end }
    }

    /* modal - MUCH LARGER for better readability */
    #modal{ display:none; position:fixed; inset:0; align-items:center; justify-content:center; z-index:10050; background:rgba(8,12,16,0.25) }
    .dialog{ width:min(1100px,96%); max-height:90vh; background:var(--white); border-radius:14px; box-shadow:0 24px 60px rgba(12,18,30,0.15); overflow:visible; display:flex; flex-direction:column; position:relative; z-index:10060; }
    .dialog.stats { width:min(720px,92%); z-index:10060; }
    .dialog.stats .timeline-entry, .dialog.stats .task-card { padding:12px; margin-bottom:10px; border-radius:10px; font-size:15px; }
    .dialog.stats .timeline-entry { border-radius:10px }
    .dialog.stats .actions-row { display:flex; gap:8px }
    .dialog.stats .dialog-footer { display:none }
    .dialog-header{ display:flex; justify-content:space-between; align-items:center; padding:24px 30px; border-bottom:1px solid var(--gray-200) }
    .dialog-body{ padding:30px; font-size:16px; overflow-y:auto; max-height:calc(90vh - 180px); }
    .dialog-footer{ padding:24px 30px; display:flex; justify-content:flex-end; gap:10px; border-top:1px solid var(--gray-200) }
    .field{ position:relative; margin-bottom:24px }
    .floating-label{ position:absolute; left:16px; top:20px; font-size:16px; color:var(--gray-600); pointer-events:none; transform-origin:left top; transition: all .14s ease }
    .field input, .field textarea, .field select{ width:100%; padding:24px 16px 14px; border-radius:10px; border:1px solid var(--gray-200); background:var(--white); font-size:16px; line-height:1.5; }
    .field textarea{ min-height:120px; resize:vertical; }
    .field.has-value .floating-label, .field input:focus + .floating-label, .field textarea:focus + .floating-label, .field select:focus + .floating-label { transform: translateY(-14px) scale(.88); color:var(--gray-600) }

    /* focus styles */
    :focus { outline: 3px solid rgba(59,130,246,0.6); outline-offset: 2px; box-shadow: 0 3px 8px rgba(59,130,246,0.12); }
    button:focus, .btn:focus { outline: 3px solid rgba(59,130,246,0.85); }

    /* toast container */
    #toast-container { position:fixed; right:18px; top:18px; z-index:15000; pointer-events:none; }
    .toast { pointer-events:auto; padding:12px 14px; border-radius:8px; color:#fff; font-weight:700; margin-top:8px; box-shadow:0 6px 18px rgba(0,0,0,0.08); display:flex; gap:10px; align-items:center; font-size:14px; }

    /* visible sort pill */
    #sortDisplay {
      display:inline-block;
      min-width:100px;
      padding:8px 14px;
      border-radius:999px;
      border:2px solid rgba(14,165,233,0.18);
      background: linear-gradient(180deg,#ffffff,#f2fbff);
      color: #064e8a;
      font-weight:800;
      font-size:14px;
      text-align:center;
      box-shadow: 0 6px 16px rgba(14,165,233,0.06);
      transition: transform .18s cubic-bezier(.2,.9,.3,1), opacity .12s ease;
      margin-left:8px;
      vertical-align:middle;
    }

    select { color: #0f172a; background: #ffffff; position: relative; z-index: auto; -webkit-appearance: menulist; appearance: menulist; }
    select option { color: #0f172a; background: #ffffff; }
    select:focus { outline: 3px solid rgba(16,185,129,0.12); }

    .fade-out { opacity:0; transform: translateY(-6px) scale(.995); }
    .fade-in  { opacity:1; transform: translateY(0) scale(1); }

    @media(max-width:640px){
      .task-right{ display:none }
      .main-grid{ grid-template-columns:1fr }
      #sortDisplay{ min-width:80px; padding:6px 10px; font-size:13px; }
      .topbar-content { flex-direction: column; }
      .topbar-right { flex-wrap: wrap; }
    }

    /* Task title and description larger */
    .task-title { font-size:18px !important; font-weight:800; color:#0f172a; }
    .task-desc { font-size:15px !important; color:var(--gray-600); margin-top:6px; }

    /* Archive modal styles */
    .archive-item {
      border-radius:10px;
      padding:18px;
      margin-bottom:14px;
      border:1px solid var(--gray-200);
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:#fafafa;
    }
    .archive-item .archive-content {
      flex:1;
      max-width:70%;
    }
    .archive-item .archive-title {
      font-weight:800;
      font-size:17px;
      color:#0f172a;
      margin-bottom:6px;
    }
    .archive-item .archive-desc {
      color:var(--gray-600);
      font-size:14px;
      margin-top:6px;
    }
    .archive-item .archive-meta {
      color:var(--gray-600);
      font-size:13px;
      margin-top:8px;
    }
    .archive-item .archive-actions {
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    /* Section headers */
    .section-header {
      font-size: 18px;
      font-weight: 800;
      color: #0f172a;
      margin: 0 0 16px 0;
    }

    /* Panel headers with controls */
    .panel-header {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
    }

    .panel-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
  </style>
{% endblock %}

{% block body %}
  <a href="#main-content" class="sr-only" id="skip-link">Skip to main content</a>

  <div class="planner-page" id="main-content">

    <!-- Topbar matching image layout -->
    <div class="site-topbar" role="banner" aria-label="Planner topbar">
      <div class="topbar-content">
        <div class="topbar-left">
          <div class="topbar-title-section">
            <h1 class="page-title">Planner</h1>
            <div class="muted-note">Organize your assignments and study schedule â€” timeline & board views.</div>
          </div>
          
          <div class="topbar-actions">
            <button id="toggleView" class="btn" type="button" aria-pressed="true" aria-label="Toggle timeline or board view">Timeline View</button>
            <button id="btnAdd" class="btn primary" type="button" aria-label="Add task">+ Add Task</button>
            <button id="btnRecoverList" class="btn" type="button" aria-label="View archived tasks">View Archive</button>
          </div>
        </div>

        <div class="topbar-right">
          <button id="top-pending" class="stat-tile" type="button" aria-label="View pending tasks">
            <div class="stat-label">Pending Tasks</div>
            <div class="stat-number" id="stat-pending">0</div>
          </button>
          <button id="top-completed" class="stat-tile" type="button" aria-label="View completed tasks">
            <div class="stat-label">Completed</div>
            <div class="stat-number" id="stat-completed">0</div>
          </button>
          <button id="top-high" class="stat-tile" type="button" aria-label="View high priority tasks">
            <div class="stat-label">High Priority</div>
            <div class="stat-number" id="stat-high">0</div>
          </button>
          <button id="top-week" class="stat-tile" type="button" aria-label="View due this week">
            <div class="stat-label">Due This Week</div>
            <div class="stat-number" id="stat-week">0</div>
          </button>
        </div>
      </div>
    </div>

    <!-- Main grid with 2.5:1.5 ratio -->
    <div class="main-grid">
      <div class="panel">
        <div class="panel-header">
          <div class="panel-title-row">
            <strong class="section-header" style="margin:0;">All Tasks</strong>
            
            <div id="seg" class="seg" data-tab="all" aria-label="Task filters" role="tablist" tabindex="0">
              <div class="thumb" aria-hidden="true"></div>
              <button data-tab="all" class="active" role="tab" aria-selected="true" aria-label="All">All</button>
              <button data-tab="pending" role="tab" aria-selected="false" aria-label="Pending">Pending</button>
              <button data-tab="completed" role="tab" aria-selected="false" aria-label="Completed">Completed</button>
              <button data-tab="high" role="tab" aria-selected="false" aria-label="High Priority">High</button>
            </div>
          </div>

          <div class="panel-controls">
            <div class="search-inline" role="search" aria-label="Search tasks" style="flex:1;max-width:280px;">
              <input id="search" placeholder="Search tasks..." aria-label="Search tasks" style="border:0;outline:0;width:100%;color:#0f172a;font-size:15px;" />
            </div>

            <div class="controls-row" style="margin-left:auto;">
              <label id="sortLabel" class="sort-label" for="sortSel">Sort</label>
              <select id="sortSel" class="btn" aria-label="Sort tasks">
                <option value="due">Due date</option>
                <option value="priority">Priority</option>
                <option value="created">Newest</option>
              </select>
              <span id="sortDisplay" aria-hidden="true">Due date</span>
            </div>
          </div>
        </div>

        <div id="taskList" style="min-height:300px"></div>
      </div>

      <aside class="panel" aria-labelledby="upcoming-title">
        <h4 id="upcoming-title" class="section-header">Upcoming Deadlines</h4>
        <div id="deadlines" class="muted-note" style="font-size:15px;">No upcoming deadlines.</div>

        <div style="margin-top:28px">
          <h4 class="section-header">Quick Stats</h4>
          <div style="display:flex;flex-direction:column;gap:12px;margin-top:10px">
            <div style="display:flex;justify-content:space-between;font-size:15px;"><div class="muted-note">Tasks to Complete</div><div id="stat-to-complete" style="font-weight:800;">0</div></div>
            <div style="display:flex;justify-content:space-between;font-size:15px;"><div class="muted-note">Overdue</div><div id="stat-overdue" style="font-weight:800;">0</div></div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Edit/Add Task Modal -->
  <div id="modal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="dialog-header">
        <h3 id="modalTitle" style="font-size:20px;">Add Task</h3>
        <button class="close-x iconbtn" id="btnClose" aria-label="Close dialog" type="button">âœ•</button>
      </div>

      <div class="dialog-body">
        <form id="taskForm" autocomplete="off" novalidate>
          <input type="hidden" id="taskId">
          <div class="field">
            <input id="title" class="input" type="text" placeholder=" " required aria-required="true">
            <label class="floating-label" for="title">Task Name</label>
          </div>

          <div style="display:flex;gap:16px;">
            <div class="field" style="flex:1;">
              <input id="dueDate" class="input" type="text" placeholder=" " required aria-required="true" aria-label="Due date">
              <label class="floating-label" for="dueDate">Due Date</label>
            </div>
            <div class="field" style="width:200px;">
              <select id="type" class="input" aria-label="Type">
                <option value="assignment">Assignment</option>
                <option value="study">Study</option>
                <option value="project">Project</option>
                <option value="exam">Exam</option>
              </select>
              <label class="floating-label" for="type">Type</label>
            </div>
          </div>

          <div class="field">
            <select id="priority" class="input" aria-label="Priority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
            <label class="floating-label" for="priority">Priority</label>
          </div>

          <div class="field">
            <textarea id="desc" class="input" placeholder=" " aria-label="Description"></textarea>
            <label class="floating-label" for="desc">Description</label>
          </div>

          <div style="display:flex;align-items:center;gap:10px;margin-top:16px;">
            <input class="round" id="completed" type="checkbox">
            <label for="completed" style="font-weight:700;color:#0f172a;font-size:16px;">Mark completed</label>
          </div>
        </form>
      </div>

      <div class="dialog-footer">
        <button id="btnCancel" class="btn secondary" type="button">Cancel</button>
        <button id="saveBtn" class="btn primary" type="button">Save Task</button>
      </div>
    </div>
  </div>

  <div id="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- Stats modal -->
  <div id="statsModal" aria-hidden="true" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;z-index:10070;background:rgba(8,12,16,0.25)">
    <div class="dialog stats" role="dialog" aria-modal="true" aria-labelledby="statsModalTitle">
      <div class="dialog-header" style="align-items:flex-start;gap:12px;">
        <div style="display:flex;flex-direction:column;gap:6px;min-width:0">
          <h3 id="statsModalTitle" style="margin:0;font-size:19px;">Tasks</h3>
          <div style="font-size:14px;color:var(--gray-600)">Quick view of tasks â€” switch filters below</div>
        </div>

        <div style="margin-left:auto;display:flex;flex-direction:column;align-items:flex-end;gap:8px;">
          <div id="stats-seg" class="seg" data-tab="all" aria-label="Task filters" role="tablist" tabindex="0" style="margin:0">
            <div class="thumb" aria-hidden="true"></div>
            <button data-tab="all" class="active" role="tab" aria-selected="true" aria-label="All">All</button>
            <button data-tab="pending" role="tab" aria-selected="false" aria-label="Pending">Pending</button>
            <button data-tab="completed" role="tab" aria-selected="false" aria-label="Completed">Completed</button>
            <button data-tab="high" role="tab" aria-selected="false" aria-label="High Priority">High</button>
          </div>

          <div class="controls-row" style="align-items:center">
            <label class="sort-label" for="statsSortSel" style="margin-right:6px">Sort</label>
            <select id="statsSortSel" class="btn">
              <option value="due">Due date</option>
              <option value="priority">Priority</option>
              <option value="created">Newest</option>
            </select>
          </div>
        </div>
        <button class="close-x iconbtn" id="statsClose" aria-label="Close" type="button" style="position:absolute;right:20px;top:20px;">âœ•</button>
      </div>
      <div class="dialog-body" style="max-height:60vh;overflow:auto;padding-top:10px;">
        <div id="statsList"></div>
      </div>
    </div>
  </div>

  <!-- Archive Modal -->
  <div id="recoverModal" aria-hidden="true" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;z-index:10050;background:rgba(8,12,16,0.25)">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="recoverTitle" style="width:min(1000px,94%);max-height:85vh;">
      <div class="dialog-header">
        <h3 id="recoverTitle" style="font-size:20px;">Task Archive</h3>
        <button class="close-x iconbtn" id="recoverClose" aria-label="Close" type="button">âœ•</button>
      </div>
      <div class="dialog-body" style="overflow-y:auto;">
        <div id="recoverList"></div>
      </div>
      <div class="dialog-footer">
        <button id="recoverCloseBtn" class="btn secondary" type="button">Close</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" aria-hidden="true" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;z-index:10050;background:rgba(8,12,16,0.3)">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="deleteTitle" style="width:480px;">
      <div class="dialog-header">
        <h3 id="deleteTitle" style="font-size:19px;">Archive task?</h3>
        <button class="close-x iconbtn" id="deleteClose" aria-label="Close" type="button">âœ•</button>
      </div>
      <div class="dialog-body">
        <p id="deleteBody" style="font-size:15px;">Are you sure you want to archive this task? You can restore it from the archive later.</p>
      </div>
      <div class="dialog-footer" style="justify-content:space-between">
        <div></div>
        <div style="display:flex;gap:8px">
          <button id="deleteCancel" class="btn secondary" type="button">Cancel</button>
          <button id="deleteConfirm" class="btn" type="button">Archive</button>
        </div>
      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script>
    // Helper functions
    function readCookie(name) {
      const m = document.cookie.match('(?:^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return m ? decodeURIComponent(m[1]) : null;
    }

    function csrfHeader() {
      const token = readCookie('csrf_token');
      return token ? { 'X-CSRF-Token': token } : {};
    }

    function showToast(msg, type='info', opts = {}) {
      const container = document.getElementById('toast-container');
      const el = document.createElement('div');
      el.className = 'toast';
      el.setAttribute('role','status');
      el.style.opacity = '0';
      el.style.transform = 'translateY(-6px)';
      el.style.transition = 'opacity .18s ease, transform .18s ease';
      el.style.background = type === 'error' ? '#ef4444' : (type === 'success' ? '#16a34a' : '#0ea5e9');
      
      const text = document.createElement('div');
      text.textContent = msg;
      text.style.flex = '1';
      el.appendChild(text);

      if (opts.actionText && typeof opts.actionCallback === 'function') {
        const actionBtn = document.createElement('button');
        actionBtn.textContent = opts.actionText;
        actionBtn.setAttribute('type','button');
        actionBtn.className = 'btn';
        actionBtn.style.background = 'transparent';
        actionBtn.style.border = '1px solid rgba(255,255,255,0.25)';
        actionBtn.style.color = '#fff';
        actionBtn.style.padding = '7px 10px';
        actionBtn.style.borderRadius = '6px';
        actionBtn.style.fontSize = '13px';
        actionBtn.style.fontWeight = '700';
        actionBtn.addEventListener('click', () => {
          if (el._timeout) clearTimeout(el._timeout);
          opts.actionCallback();
          el.remove();
        });
        el.appendChild(actionBtn);
      }

      container.appendChild(el);
      requestAnimationFrame(()=>{ el.style.opacity='1'; el.style.transform='translateY(0)'; });

      const duration = opts.duration || 4000;
      el._timeout = setTimeout(()=> {
        el.style.opacity='0'; el.style.transform='translateY(-6px)';
        setTimeout(()=> el.remove(), 220);
      }, duration);
    }

    // State & elements
    const listEl = document.getElementById('taskList');
    const dlEl = document.getElementById('deadlines');
    const statPending = document.getElementById('stat-pending');
    const statCompleted = document.getElementById('stat-completed');
    const statHigh = document.getElementById('stat-high');
    const statWeek = document.getElementById('stat-week');
    const searchEl = document.getElementById('search');
    const seg = document.getElementById('seg');
    const sortSel = document.getElementById('sortSel');

    const modal = document.getElementById('modal');
    const btnAdd = document.getElementById('btnAdd');
    const btnClose = document.getElementById('btnClose');
    const btnCancel = document.getElementById('btnCancel');
    const btnSave = document.getElementById('saveBtn');
    const toggleViewBtn = document.getElementById('toggleView');

    const form = document.getElementById('taskForm');
    const fldId = document.getElementById('taskId');
    const fldTitle = document.getElementById('title');
    const fldDueDate = document.getElementById('dueDate');
    const fldType = document.getElementById('type');
    const fldPriority = document.getElementById('priority');
    const fldDesc = document.getElementById('desc');
    const fldCompleted = document.getElementById('completed');
    const modalTitle = document.getElementById('modalTitle');

    const deleteModal = document.getElementById('deleteModal');
    const deleteConfirm = document.getElementById('deleteConfirm');
    const deleteCancel = document.getElementById('deleteCancel');
    const deleteClose = document.getElementById('deleteClose');
    let _pendingDeleteTargetId = null;

    const recoverModal = document.getElementById('recoverModal');
    const recoverList = document.getElementById('recoverList');
    const recoverClose = document.getElementById('recoverClose');
    const recoverCloseBtn = document.getElementById('recoverCloseBtn');
    const btnRecoverList = document.getElementById('btnRecoverList');

    const statsModal = document.getElementById('statsModal');
    const statsList = document.getElementById('statsList');
    const statsClose = document.getElementById('statsClose');

    let currentTab = 'all';
    let currentSearch = '';
    let timelineView = true;

    // Flatpickr init
    function initPlannerDatepicker(){
      const el = document.getElementById('dueDate');
      if(!el) return;
      if(window._plannerFP && window._plannerFP.destroy) window._plannerFP.destroy();
      window._plannerFP = flatpickr(el, {
        enableTime:false,
        dateFormat:"Y-m-d",
        defaultDate:null,
        allowInput: true,
        onChange(){ tuneFloatingLabels(); }
      });
      el.addEventListener('focus', ()=> { try { window._plannerFP.open(); } catch(e){} });
    }

    function fmtDate(dateStr){ 
      if(!dateStr) return ''; 
      try { 
        const d=new Date(dateStr); 
        return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}); 
      } catch(e){ 
        return dateStr; 
      } 
    }

    function daysDiff(dateStr){ 
      if(!dateStr) return 9999; 
      const today=new Date(); 
      today.setHours(0,0,0,0); 
      const d=new Date(dateStr); 
      d.setHours(0,0,0,0); 
      return Math.round((d - today)/(1000*60*60*24)); 
    }

    function typeBadge(t){ 
      const map={assignment:'tag',study:'tag',project:'tag secondary',exam:'tag'}; 
      return `<span class="${map[t]||'tag'}">${t}</span>`; 
    }
    
    function prBadge(p){ 
      const map={high:'priority-high',medium:'priority-medium',low:'priority-low'}; 
      return `<span class="badge ${map[p]||''}">${p}</span>`; 
    }

    // API wrappers
    async function apiGetTasks({ search='', filter='all', sort='due' } = {}) {
      const q = new URLSearchParams();
      if (search) q.set('search', search);
      if (filter) q.set('filter', filter);
      if (sort) q.set('sort', sort);
      const res = await fetch(`/api/tasks?${q.toString()}`, { credentials: 'same-origin' });
      if (!res.ok) throw new Error('Failed fetching tasks');
      return res.json();
    }

    async function apiCreateTask(payload) {
      const res = await fetch('/api/tasks', {
        method: 'POST',
        headers: Object.assign({'Content-Type':'application/json'}, csrfHeader()),
        credentials: 'same-origin',
        body: JSON.stringify(payload)
      });
      return res;
    }

    async function apiUpdateTask(id, payload) {
      const res = await fetch(`/api/tasks/${id}`, {
        method: 'PATCH',
        headers: Object.assign({'Content-Type':'application/json'}, csrfHeader()),
        credentials: 'same-origin',
        body: JSON.stringify(payload)
      });
      return res;
    }

    async function apiGetStats() {
      const res = await fetch('/api/tasks/stats', { credentials: 'same-origin' });
      if (!res.ok) throw new Error('Failed fetching stats');
      return res.json();
    }

    async function apiArchiveTask(id) {
      const res = await fetch(`/api/tasks/${id}/archive`, {
        method: 'POST',
        headers: csrfHeader(),
        credentials: 'same-origin'
      });
      return res;
    }

    async function apiGetArchives() {
      const res = await fetch('/api/tasks/archive', { credentials: 'same-origin' });
      if (!res.ok) throw new Error('Failed fetching archives');
      return res.json();
    }

    async function apiRestoreArchive(archiveId) {
      const res = await fetch(`/api/tasks/archive/${archiveId}/restore`, {
        method: 'POST',
        headers: csrfHeader(),
        credentials: 'same-origin'
      });
      return res;
    }

    async function apiDeleteArchivePermanent(archiveId) {
      const res = await fetch(`/api/tasks/archive/${archiveId}/permanent`, {
        method: 'DELETE',
        headers: csrfHeader(),
        credentials: 'same-origin'
      });
      return res;
    }

    // Render functions
    function renderTasks(tasks){
      listEl.innerHTML = '';
      if (!tasks.length){ 
        listEl.innerHTML = `<div style="padding:24px;color:var(--muted);font-size:16px;">No tasks found.</div>`; 
        return; 
      }

      if (timelineView){
        const wrap = document.createElement('div'); 
        wrap.className = 'timeline';
        tasks.forEach(t => {
          const diff = daysDiff(t.dueDate);
          const el = document.createElement('div'); 
          el.className = 'timeline-entry';
          el.innerHTML = `
            <div class="timeline-dot" title="${fmtDate(t.dueDate)}"></div>
            <div style="flex:1">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div class="task-title">${t.title}</div>
                <div style="font-size:15px;color:var(--gray-600);font-weight:700;">${fmtDate(t.dueDate)}</div>
              </div>
              <div class="task-desc">${(t.desc||'')}</div>
              <div style="margin-top:12px">${typeBadge(t.type)} ${prBadge(t.priority)}</div>
            </div>
            <div style="width:160px;text-align:right">
              <div style="margin-bottom:10px">
                <button class="iconbtn edit" data-id="${t.id}" type="button" aria-label="Edit">Edit</button> 
                <button class="iconbtn delete" data-id="${t.id}" type="button" aria-label="Archive">Archive</button>
              </div>
            </div>
          `;
          wrap.appendChild(el);
        });
        listEl.appendChild(wrap);
        return;
      }

      for (const t of tasks){
        const diff = daysDiff(t.dueDate);
        const overdue = diff < 0;
        const statusHtml = t.completed ? 
          `<div style="color:var(--planner-accent);font-weight:800;font-size:15px;">Completed</div>` : 
          `<div style="color:var(--gray-600);font-weight:800;font-size:15px;">In Progress</div>`;
        const item = document.createElement('div'); 
        item.className = 'task-card';
        item.innerHTML = `
          <div class="task-left" style="flex:1;">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
              <div style="display:flex;align-items:center;gap:12px">
                <input type="checkbox" class="round toggle-complete" data-id="${t.id}" ${t.completed ? 'checked' : ''}/>
                <div style="min-width:0">
                  <div class="task-title">${t.title}</div>
                  <div class="task-desc">${t.desc || ''}</div>
                </div>
              </div>
              <div style="text-align:right">${statusHtml}</div>
            </div>

            <div style="margin-top:12px;display:flex;gap:12px;align-items:center;color:var(--gray-600);font-size:15px">
              <div>ðŸ“… Due: ${fmtDate(t.dueDate)}</div>
              ${overdue ? 
                `<div style="color:var(--accent-2);font-weight:800;">${Math.abs(diff)}d overdue</div>` : 
                `<div class="muted-note">${diff}d left</div>`}
            </div>

            <div style="margin-top:12px">${typeBadge(t.type)} ${prBadge(t.priority)}</div>
          </div>

          <div class="task-right">
            <div class="actions-row">
              <button class="iconbtn edit" data-id="${t.id}" aria-label="Edit" type="button">Edit</button>
              <button class="iconbtn delete" data-id="${t.id}" aria-label="Archive" type="button">Archive</button>
            </div>
          </div>
        `;
        listEl.appendChild(item);
      }
    }

    async function renderDeadlinesAndStats() {
      try {
        const stats = await apiGetStats();
        statPending.textContent = stats.pending;
        statCompleted.textContent = stats.completed;
        statHigh.textContent = stats.high;
        statWeek.textContent = stats.dueWeek;
        document.getElementById('stat-to-complete').textContent = stats.pending;
        document.getElementById('stat-overdue').textContent = stats.overdue;
      } catch (e) {
        console.warn('stats fetch failed', e);
      }

      try {
        const all = await apiGetTasks({ search: '', filter: 'pending', sort: 'due' });
        const today = new Date(); 
        today.setHours(0,0,0,0);
        const in7 = new Date(today.getTime() + 7*24*60*60*1000);
        const upcoming = all.filter(t => t.dueDate).filter(t => {
          const d = new Date(t.dueDate);
          d.setHours(0,0,0,0);
          return d >= today && d <= in7;
        }).slice(0,5);

        if (!upcoming.length){ 
          dlEl.innerHTML = `<div class="muted-note" style="font-size:15px;">No upcoming deadlines.</div>`; 
        } else {
          dlEl.innerHTML = upcoming.map(t=>{
            const diff = daysDiff(t.dueDate);
            const chip = diff < 0 ? 
              `<span class="badge priority-high">${Math.abs(diff)}d overdue</span>` : 
              `<span class="badge" style="background:#fff7ed;color:#c2410c;border-color:#fed7aa">${diff}d</span>`;
            return `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
              <div style="max-width:60%">
                <div style="font-weight:800;font-size:16px;">${t.title}</div>
                <div style="color:var(--gray-600);font-size:14px;margin-top:4px;">${(t.desc||'').slice(0,60)}${(t.desc||'').length>60?'...':''}</div>
                <div style="margin-top:8px">${prBadge(t.priority)}</div>
              </div>
              <div style="text-align:right">
                ${chip}
              </div>
            </div>`;
          }).join('');
        }
      } catch (e) {
        dlEl.innerHTML = `<div class="muted-note">Unable to load deadlines.</div>`;
      }
    }

    // CRUD operations
    async function load() {
      try {
        const sortBy = sortSel.value || 'due';
        const tasks = await apiGetTasks({ search: currentSearch, filter: currentTab, sort: sortBy });
        renderTasks(tasks);
        await renderDeadlinesAndStats();
      } catch (e) {
        listEl.innerHTML = `<div style="padding:24px;color:var(--muted);font-size:16px;">Failed loading tasks.</div>`;
        console.error(e);
      }
    }

    async function saveTask(){
      const isEdit = Boolean(fldId.value);
      const payload = {
        title: fldTitle.value.trim(),
        desc: fldDesc.value.trim(),
        type: fldType.value,
        priority: fldPriority.value,
        dueDate: fldDueDate.value || (window._plannerFP && window._plannerFP.input && window._plannerFP.input.value) || '',
        completed: !!fldCompleted.checked
      };
      
      if (!payload.title || !payload.dueDate){ 
        showToast('Title and due date are required','error'); 
        return; 
      }

      try {
        if (isEdit) {
          const id = fldId.value;
          const r = await apiUpdateTask(id, payload);
          if (!r.ok) {
            const j = await r.json().catch(()=>({}));
            throw new Error(j.message || 'Update failed');
          }
          showToast('Task updated','success');
        } else {
          const r = await apiCreateTask(payload);
          if (!r.ok) {
            const j = await r.json().catch(()=>({}));
            throw new Error(j.message || 'Create failed');
          }
          showToast('Task added','success');
        }
        hideModal();
        await load();
      } catch (err) {
        showToast(err.message || 'Save failed','error');
      }
    }

    async function scheduleDelete(taskId){
      try {
        const res = await apiArchiveTask(taskId);
        
        if (!res.ok) {
          const j = await res.json().catch(()=>({}));
          throw new Error(j.message || 'Archive failed');
        }
        
        const body = await res.json().catch(()=>({}));
        const archiveId = body.archive_id;
        
        showToast(`Task archived`, 'success', {
          actionText: 'Undo',
          actionCallback: async () => {
            if (archiveId) {
              try {
                const r = await apiRestoreArchive(archiveId);
                if (r.ok) { 
                  showToast('Restore successful','success'); 
                  load(); 
                  return; 
                }
              } catch(e){}
            }
            showToast('Undo failed','error');
          },
          duration: 8000
        });
        load();
      } catch (err) {
        showToast(err.message || 'Archive failed','error');
      }
    }

    // Archive modal
    async function openRecoverModal(){
      try {
        const list = await apiGetArchives();
        
        if (!list || !list.length) {
          recoverList.innerHTML = '<div style="padding:24px;color:var(--muted);font-size:16px;">No archived tasks.</div>';
        } else {
          recoverList.innerHTML = list.map(p => {
            const snap = p.snapshot || {};
            const title = snap.title || `Task`;
            const archivedDate = p.archived_at ? new Date(p.archived_at).toLocaleDateString() : '';
            
            return `<div class="archive-item">
              <div class="archive-content">
                <div class="archive-title">${title}</div>
                <div class="archive-desc">${(snap.desc||'')}</div>
                <div style="margin-top:10px">
                  ${snap.priority ? prBadge(snap.priority) : ''}
                  ${snap.type ? typeBadge(snap.type) : ''}
                </div>
                ${archivedDate ? '<div class="archive-meta">Archived: ' + archivedDate + '</div>' : ''}
              </div>
              <div class="archive-actions">
                <button class="btn btn-restore" data-archive-id="${p.id}">Restore</button>
                <button class="btn btn-delete-perm" data-archive-id="${p.id}" style="background:#ef4444;color:white;border:1px solid #dc2626;">Delete Forever</button>
              </div>
            </div>`;
          }).join('');
        }

        setTimeout(()=> {
          const restoreBtns = recoverList.querySelectorAll('button[data-archive-id].btn-restore');
          restoreBtns.forEach(b => b.addEventListener('click', async (ev) => {
            const aid = b.getAttribute('data-archive-id');
            try {
              const res = await apiRestoreArchive(aid);
              if (res.ok) { 
                showToast('Restore successful','success'); 
                openRecoverModal(); 
                load(); 
              } else {
                const j = await res.json().catch(()=>({}));
                showToast(j.message || 'Restore failed','error');
              }
            } catch (e) {
              showToast('Restore failed','error');
            }
          }));
          
          const deleteBtns = recoverList.querySelectorAll('button[data-archive-id].btn-delete-perm');
          deleteBtns.forEach(b => b.addEventListener('click', async (ev) => {
            if (!confirm('Permanently delete this task? This cannot be undone.')) return;
            const aid = b.getAttribute('data-archive-id');
            try {
              const res = await apiDeleteArchivePermanent(aid);
              if (res.ok) { 
                showToast('Permanently deleted','success'); 
                openRecoverModal(); 
              } else {
                const j = await res.json().catch(()=>({}));
                showToast(j.message || 'Delete failed','error');
              }
            } catch (e) {
              showToast('Delete failed','error');
            }
          }));
        }, 40);

        if (recoverModal){ 
          recoverModal.style.display = 'flex'; 
          recoverModal.setAttribute('aria-hidden','false'); 
        }
      } catch (e) {
        showToast('Failed to load archive','error');
      }
    }

    // Stats modal function
    async function loadStatsModal(filter = 'all') {
      try {
        const sortBy = document.getElementById('statsSortSel').value || 'due';
        const tasks = await apiGetTasks({ search: '', filter: filter, sort: sortBy });
        
        if (!tasks.length) {
          statsList.innerHTML = '<div style="padding:24px;color:var(--muted);font-size:15px;">No tasks found.</div>';
          return;
        }

        statsList.innerHTML = tasks.map(t => {
          const diff = daysDiff(t.dueDate);
          const overdue = diff < 0;
          return `<div class="timeline-entry">
            <div style="flex:1">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div class="task-title">${t.title}</div>
                <div style="font-size:14px;color:var(--gray-600);font-weight:700;">${fmtDate(t.dueDate)}</div>
              </div>
              <div class="task-desc">${(t.desc||'')}</div>
              <div style="margin-top:10px">${typeBadge(t.type)} ${prBadge(t.priority)}</div>
            </div>
          </div>`;
        }).join('');
      } catch (e) {
        statsList.innerHTML = '<div style="padding:24px;color:var(--muted);">Failed to load tasks.</div>';
      }
    }

    // Modal helpers
    function trapFocus(modalEl) {
      const focusableSelectors = 'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])';
      let focusable = Array.from(modalEl.querySelectorAll(focusableSelectors));
      focusable = focusable.filter(el => {
        try { return !!(el.offsetWidth || el.offsetHeight || el.getClientRects().length); } catch(e) { return false; }
      });
      if (!focusable.length) return { release: ()=>{} };

      let first = focusable[0];
      let last = focusable[focusable.length - 1];

      function handleKey(e) {
        if (e.key !== 'Tab') return;
        if (e.shiftKey && document.activeElement === first) {
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      }
      document.addEventListener('keydown', handleKey);
      return {
        release() {
          document.removeEventListener('keydown', handleKey);
        }
      };
    }

    let _modalFocusTrap = null;
    let _lastFocusedEl = null;

    function showModal(isEdit=false, task=null){
      _lastFocusedEl = document.activeElement;
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
      document.body.classList.add('modal-open');
      _modalFocusTrap = trapFocus(document.querySelector('#modal .dialog'));

      if (isEdit && task){
        modalTitle.textContent = 'Edit Task';
        fldId.value = task.id;
        fldTitle.value = task.title || '';
        const dstr = task.dueDate ? String(task.dueDate).slice(0,10) : null;
        if (window._plannerFP && dstr) {
          try { window._plannerFP.setDate(dstr, true, "Y-m-d"); } catch(e) { fldDueDate.value = (task.dueDate||'').slice(0,10); }
        } else fldDueDate.value = (task.dueDate||'').slice(0,10);
        fldType.value = task.type;
        fldPriority.value = task.priority;
        fldDesc.value = task.desc || '';
        fldCompleted.checked = !!task.completed;
      } else {
        modalTitle.textContent = 'Add Task';
        fldId.value = '';
        form.reset();
        if (window._plannerFP) window._plannerFP.clear();
      }
      tuneFloatingLabels();
      setTimeout(()=> {
        const first = document.querySelector('#modal .dialog').querySelector('input,select,textarea,button,[tabindex]:not([tabindex="-1"])');
        if (first) first.focus();
      }, 50);
    }

    function hideModal(){ 
      modal.style.display = 'none'; 
      modal.setAttribute('aria-hidden','true'); 
      document.body.classList.remove('modal-open'); 
      if (_modalFocusTrap && _modalFocusTrap.release) _modalFocusTrap.release();
      if (_lastFocusedEl && _lastFocusedEl.focus) _lastFocusedEl.focus();
    }

    function tuneFloatingLabels(){
      document.querySelectorAll('.field').forEach(f=>{
        const input = f.querySelector('.input') || f.querySelector('input') || f.querySelector('textarea') || f.querySelector('select');
        if (!input) return;
        if ((input.value && String(input.value).trim().length) || (input.selectedOptions && input.selectedOptions.length && input.selectedOptions[0].value !== '')) 
          f.classList.add('has-value'); 
        else 
          f.classList.remove('has-value');
      });
    }
    document.addEventListener('input', tuneFloatingLabels);
    document.addEventListener('change', tuneFloatingLabels);

    // Segmented control with proper thumb positioning
    function updateThumb(segEl = seg) {
      if (!segEl) return;
      const thumbEl = segEl.querySelector('.thumb');
      const active = segEl.querySelector('button.active') || segEl.querySelector('button[data-tab="all"]');
      if (!active || !thumbEl) return;

      const segRect = segEl.getBoundingClientRect();
      const btnRect = active.getBoundingClientRect();

      const left = Math.round(btnRect.left - segRect.left);
      const width = Math.round(btnRect.width);

      thumbEl.style.width = width + 'px';
      thumbEl.style.transform = `translateX(${left}px)`;
      thumbEl.style.opacity = '1';

      segEl.querySelectorAll('button').forEach(b => {
        if (b !== active) {
          b.style.color = '#6b7280';
          b.style.zIndex = 2;
        }
      });
      active.style.color = '#fff';
      active.style.zIndex = 3;
    }

    if (seg) {
      seg.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-tab]');
        if (!btn) return;
        [...seg.querySelectorAll('button')].forEach(b => { 
          b.classList.remove('active'); 
          b.setAttribute('aria-selected','false'); 
        });
        btn.classList.add('active');
        btn.setAttribute('aria-selected','true');
        currentTab = btn.dataset.tab;
        updateThumb();
        load();
      });

      seg.addEventListener('keydown', (e) => {
        const buttons = Array.from(seg.querySelectorAll('button[data-tab]'));
        const activeIndex = buttons.findIndex(b => b.classList.contains('active'));
        if (e.key === 'ArrowRight' || e.key === 'ArrowDown'){
          e.preventDefault();
          const next = buttons[(activeIndex + 1) % buttons.length];
          next.focus();
          next.click();
        } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp'){
          e.preventDefault();
          const prev = buttons[(activeIndex - 1 + buttons.length) % buttons.length];
          prev.focus();
          prev.click();
        }
      });
    }

    // Stats modal segmented control
    const statsSeg = document.getElementById('stats-seg');
    if (statsSeg) {
      statsSeg.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-tab]');
        if (!btn) return;
        [...statsSeg.querySelectorAll('button')].forEach(b => { 
          b.classList.remove('active'); 
          b.setAttribute('aria-selected','false'); 
        });
        btn.classList.add('active');
        btn.setAttribute('aria-selected','true');
        updateThumb(statsSeg);
        loadStatsModal(btn.dataset.tab);
      });
    }

    // Stats modal sort handler
    const statsSortSel = document.getElementById('statsSortSel');
    if (statsSortSel) {
      statsSortSel.addEventListener('change', () => {
        const currentFilter = statsSeg.querySelector('button.active')?.dataset.tab || 'all';
        loadStatsModal(currentFilter);
      });
    }

    // Event wiring
    if (toggleViewBtn) {
      toggleViewBtn.addEventListener('click', () => {
        timelineView = !timelineView;
        toggleViewBtn.textContent = timelineView ? 'Timeline View' : 'Board View';
        toggleViewBtn.setAttribute('aria-pressed', String(timelineView));
        load();
      });
    }

    if (btnAdd) btnAdd.addEventListener('click', ()=> showModal(false,null));
    if (btnClose) btnClose.addEventListener('click', ()=> hideModal());
    if (btnCancel) btnCancel.addEventListener('click', ()=> hideModal());
    if (btnSave) btnSave.addEventListener('click', ()=> saveTask());
    
    form.addEventListener('submit', (e) => { 
      e.preventDefault(); 
      saveTask(); 
    });

    // Delete modal handlers
    if (deleteConfirm) {
      deleteConfirm.addEventListener('click', ()=> {
        if (_pendingDeleteTargetId) {
          scheduleDelete(_pendingDeleteTargetId);
          _pendingDeleteTargetId = null;
        }
        deleteModal.style.display = 'none';
        deleteModal.setAttribute('aria-hidden','true');
      });
    }
    if (deleteCancel) deleteCancel.addEventListener('click', ()=> {
      deleteModal.style.display = 'none';
      deleteModal.setAttribute('aria-hidden','true');
    });
    if (deleteClose) deleteClose.addEventListener('click', ()=> {
      deleteModal.style.display = 'none';
      deleteModal.setAttribute('aria-hidden','true');
    });

    // Archive modal handlers
    if (btnRecoverList) btnRecoverList.addEventListener('click', openRecoverModal);
    if (recoverClose) recoverClose.addEventListener('click', ()=> {
      recoverModal.style.display = 'none';
      recoverModal.setAttribute('aria-hidden','true');
    });
    if (recoverCloseBtn) recoverCloseBtn.addEventListener('click', ()=> {
      recoverModal.style.display = 'none';
      recoverModal.setAttribute('aria-hidden','true');
    });

    // Stats modal handlers
    if (statsClose) statsClose.addEventListener('click', ()=> {
      statsModal.style.display = 'none';
      statsModal.setAttribute('aria-hidden','true');
    });

    // Stat tiles click handlers
    document.getElementById('top-pending')?.addEventListener('click', ()=> {
      const active = statsSeg.querySelector('button[data-tab="pending"]');
      if (active) {
        [...statsSeg.querySelectorAll('button')].forEach(b => { 
          b.classList.remove('active'); 
          b.setAttribute('aria-selected','false'); 
        });
        active.classList.add('active');
        active.setAttribute('aria-selected','true');
        updateThumb(statsSeg);
      }
      loadStatsModal('pending');
      statsModal.style.display = 'flex';
      statsModal.setAttribute('aria-hidden','false');
    });

    document.getElementById('top-completed')?.addEventListener('click', ()=> {
      const active = statsSeg.querySelector('button[data-tab="completed"]');
      if (active) {
        [...statsSeg.querySelectorAll('button')].forEach(b => { 
          b.classList.remove('active'); 
          b.setAttribute('aria-selected','false'); 
        });
        active.classList.add('active');
        active.setAttribute('aria-selected','true');
        updateThumb(statsSeg);
      }
      loadStatsModal('completed');
      statsModal.style.display = 'flex';
      statsModal.setAttribute('aria-hidden','false');
    });

    document.getElementById('top-high')?.addEventListener('click', ()=> {
      const active = statsSeg.querySelector('button[data-tab="high"]');
      if (active) {
        [...statsSeg.querySelectorAll('button')].forEach(b => { 
          b.classList.remove('active'); 
          b.setAttribute('aria-selected','false'); 
        });
        active.classList.add('active');
        active.setAttribute('aria-selected','true');
        updateThumb(statsSeg);
      }
      loadStatsModal('high');
      statsModal.style.display = 'flex';
      statsModal.setAttribute('aria-hidden','false');
    });

    document.getElementById('top-week')?.addEventListener('click', async ()=> {
      try {
        const all = await apiGetTasks({ search: '', filter: 'pending', sort: 'due' });
        const today = new Date(); 
        today.setHours(0,0,0,0);
        const in7 = new Date(today.getTime() + 7*24*60*60*1000);
        const weekTasks = all.filter(t => t.dueDate).filter(t => {
          const d = new Date(t.dueDate);
          d.setHours(0,0,0,0);
          return d >= today && d <= in7;
        });

        if (!weekTasks.length) {
          statsList.innerHTML = '<div style="padding:24px;color:var(--muted);font-size:15px;">No tasks due this week.</div>';
        } else {
          statsList.innerHTML = weekTasks.map(t => {
            const diff = daysDiff(t.dueDate);
            return `<div class="timeline-entry">
              <div style="flex:1">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="task-title">${t.title}</div>
                  <div style="font-size:14px;color:var(--gray-600);font-weight:700;">${fmtDate(t.dueDate)}</div>
                </div>
                <div class="task-desc">${(t.desc||'')}</div>
                <div style="margin-top:10px">${typeBadge(t.type)} ${prBadge(t.priority)}</div>
              </div>
            </div>`;
          }).join('');
        }

        const active = statsSeg.querySelector('button[data-tab="all"]');
        if (active) {
          [...statsSeg.querySelectorAll('button')].forEach(b => { 
            b.classList.remove('active'); 
            b.setAttribute('aria-selected','false'); 
          });
          active.classList.add('active');
          active.setAttribute('aria-selected','true');
          updateThumb(statsSeg);
        }
        statsModal.style.display = 'flex';
        statsModal.setAttribute('aria-hidden','false');
      } catch (e) {
        showToast('Failed to load week tasks','error');
      }
    });

    // Search handler
    if (searchEl) {
      let searchTimeout;
      searchEl.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          currentSearch = e.target.value.trim();
          load();
        }, 300);
      });
    }

    // Sort handler
    if (sortSel) {
      sortSel.addEventListener('change', () => {
        document.getElementById('sortDisplay').textContent = sortSel.options[sortSel.selectedIndex].text;
        load();
      });
    }

    // Delegate event listeners for edit/delete/toggle buttons
    document.addEventListener('click', async (e) => {
      const editBtn = e.target.closest('.edit');
      const deleteBtn = e.target.closest('.delete');
      const toggleBtn = e.target.closest('.toggle-complete');

      if (editBtn) {
        const taskId = editBtn.dataset.id;
        try {
          const tasks = await apiGetTasks({ search: '', filter: 'all', sort: 'due' });
          const task = tasks.find(t => String(t.id) === String(taskId));
          if (task) showModal(true, task);
        } catch (e) {
          showToast('Failed to load task','error');
        }
      }

      if (deleteBtn) {
        const taskId = deleteBtn.dataset.id;
        _pendingDeleteTargetId = taskId;
        deleteModal.style.display = 'flex';
        deleteModal.setAttribute('aria-hidden','false');
      }

      if (toggleBtn) {
        const taskId = toggleBtn.dataset.id;
        const isChecked = toggleBtn.checked;
        try {
          const res = await apiUpdateTask(taskId, { completed: isChecked });
          if (res.ok) {
            showToast(isChecked ? 'Task completed' : 'Task reopened', 'success');
            load();
          } else {
            toggleBtn.checked = !isChecked;
            showToast('Update failed','error');
          }
        } catch (e) {
          toggleBtn.checked = !isChecked;
          showToast('Update failed','error');
        }
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initPlannerDatepicker();
      updateThumb();
      updateThumb(statsSeg);
      load();
    });

    // Also run on load if DOM already ready
    if (document.readyState === 'loading') {
      // Already attached above
    } else {
      initPlannerDatepicker();
      updateThumb();
      updateThumb(statsSeg);
      load();
    }
  </script>
{% endblock %}