<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Likhayag — Create Account</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg-1:#0f766e; --bg-2:#064e3b;
  --accent:#059669;
  --gold-1:#eab308; --gold-2:#ca8a04;
  --muted:#58686d; --input-text:#042f2c; --placeholder:#8fa2a0;
  --err:#dc2626;
  --card-shadow: 0 24px 60px rgba(3,10,18,0.14);
  --glass: rgba(255,255,255,0.96);
}

/* reset */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  background: radial-gradient(900px 450px at 8% 8%, rgba(255,255,255,0.03), transparent),
              linear-gradient(180deg,var(--bg-1),var(--bg-2));
  display:flex; align-items:center; justify-content:center; padding:28px; -webkit-font-smoothing:antialiased;
  color:#071422;
}

/* compact card */
.card{
  width:100%; max-width:640px; border-radius:20px;
  background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96));
  box-shadow: var(--card-shadow); padding:28px;
}
.brand{display:flex;flex-direction:column;align-items:center;gap:10px;margin-bottom:10px}
.logo {
  width:84px; height:84px; border-radius:20px;
  display:flex;align-items:center;justify-content:center;
  background: linear-gradient(135deg,var(--accent),#064e3b);
  box-shadow: 0 14px 36px rgba(5,150,105,0.12);
  padding:8px;
}
.logo img{ width:100%; height:100%; object-fit:contain; border-radius:14px; display:block; background:transparent; }

/* headings - slightly smaller */
h1{margin:0;font-size:22px;font-weight:800;color:#06323a}
.subtitle{margin:0;font-size:13px;color:var(--muted)}

/* form grid */
.form{margin-top:8px;display:flex;flex-direction:column;gap:10px}
label{display:block;margin-bottom:6px;font-size:13px;font-weight:700;color:#06323a}

/* inputs - more compact */
.input-wrap{position:relative}
.input{
  width:100%;
  border-radius:10px;
  padding:10px 12px;
  padding-left:50px; /* room for left icon */
  padding-right:64px; /* room for right icon */
  border:1px solid rgba(15,23,42,0.06);
  background:linear-gradient(180deg,var(--glass),#fff);
  font-size:14px; color:var(--input-text);
  transition:box-shadow .16s, border-color .16s;
  outline:none;
}
.input::placeholder{color:var(--placeholder);opacity:1}
.input:focus{box-shadow:0 10px 30px rgba(5,150,105,0.06);border-color:rgba(5,150,105,0.9)}
.input.error{border-color:var(--err);background:#fff2f2}

/* left icon */
.left-icon{
  position:absolute; left:10px; top:50%; transform:translateY(-50%);
  width:26px;height:26px; display:flex;align-items:center;justify-content:center; pointer-events:none; z-index:3;
}
.left-icon svg{width:16px;height:16px;display:block; fill:var(--muted)}

/* right icon / toggle */
.right-icon{position:absolute; right:8px; top:50%; transform:translateY(-50%); z-index:4; display:flex;align-items:center;justify-content:center}
/* make eye icons stroke-only & controlled by currentColor (accent) */
.toggle-btn{background:transparent;border:0;padding:6px;border-radius:8px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
.toggle-btn svg{width:18px;height:18px;display:block; stroke:var(--accent); fill:none; stroke-width:1.6; stroke-linecap:round; stroke-linejoin:round}
.toggle-btn:focus{outline:2px solid rgba(5,150,105,0.12);outline-offset:2px}

/* name grid */
.name-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.extras-row{display:flex;gap:10px;align-items:center;margin-top:4px}
.toggle-extras{background:none;border:0;color:var(--accent);font-weight:700;cursor:pointer;padding:0;text-decoration:underline}
.preview{background:#f7faf7;border-radius:8px;padding:8px 10px;border:1px solid rgba(15,23,42,0.04);color:var(--muted);flex:1}

/* 2FA row */
.twofa-row{display:flex;gap:8px;align-items:center}
.twofa-input{flex:1;padding:10px 12px;font-family:monospace;letter-spacing:1px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:#fff;color:var(--input-text)}

/* buttons smaller */
.btn{border:0;padding:12px 14px;border-radius:999px;font-weight:800;cursor:pointer;text-transform:uppercase;font-size:13px}
.btn-gold{background:linear-gradient(90deg,var(--gold-1),var(--gold-2));color:#fff;box-shadow:0 14px 40px rgba(234,179,8,0.12)}
.btn-ghost{background:transparent;color:#0b2624;border-radius:8px;padding:8px 10px}

/* divider */
.divider{margin:18px 0;text-align:center;position:relative;color:var(--muted)}
.divider::before{content:"";position:absolute;left:20px;right:20px;top:50%;height:1px;background:linear-gradient(90deg,transparent,#e6eef0,transparent);transform:translateY(-50%)}
.divider span{position:relative;z-index:1;padding:6px 12px;background:transparent;border-radius:999px}

/* errors */
.error-text{color:var(--err);font-size:12px;display:none;margin-top:6px}

/* password strength */
.strength-wrap{display:flex;align-items:center;gap:8px;margin-top:6px}
.strength-bar{height:7px;border-radius:999px;background:#f1f5f4;flex:1;overflow:hidden}
.strength-fill{height:100%;width:0%;background:linear-gradient(90deg,#f97316,#059669);transition:width .25s}
.strength-text{font-size:13px;color:var(--muted);min-width:76px;text-align:right;font-weight:800} /* bolder */

/* smaller helper text */
.hint{font-size:11px;color:var(--muted);margin-top:6px}

/* modal - small and responsive */
.modal-overlay{
  position:fixed; inset:0;
  background:rgba(2,6,23,0.45);
  display:flex; align-items:center; justify-content:center;
  z-index:1200; padding:14px;
  opacity:0; pointer-events:none; transition:opacity .16s;
}
.modal-overlay.show{opacity:1;pointer-events:auto}
.modal-card{
  width:100%; max-width:340px;
  max-height:78vh; overflow:auto;
  background:white; border-radius:12px; padding:14px;
  box-shadow:0 24px 60px rgba(2,6,23,0.28);
  transform:scale(.98); opacity:0; transition:transform .18s ease,opacity .18s ease;
}
.modal-overlay.show .modal-card{transform:scale(1);opacity:1}
.modal-title{font-weight:800;font-size:15px;margin-bottom:6px;color:#06323a}
.modal-desc{color:var(--muted);font-size:13px;margin-bottom:8px}
.modal-input{width:100%;border-radius:8px;padding:10px;border:1px solid rgba(15,23,42,0.06);font-family:monospace;letter-spacing:1px;font-size:14px;color:var(--input-text)}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
.modal-msg{margin-top:10px;font-size:13px}

/* center footer */
.footer{ text-align:center; color:var(--muted); margin-top:8px }

/* responsive tweaks */
@media (max-width:680px){ .card{padding:20px;max-width:92%} .name-grid{grid-template-columns:1fr} .logo{width:76px;height:76px} .modal-card{max-width:92vw;} }
@media (max-width:420px){ .input{padding-left:44px;padding-right:56px} .strength-text{display:none} }
</style>
</head>
<body>

<main class="card" role="main" aria-labelledby="create-title">
  <header class="brand">
    <div class="logo" aria-hidden="true">
      <img src="/static/images/likhayag-logo.png" alt="Likhayag logo">
    </div>
    <h1 id="create-title">Create Account</h1>
    <p class="subtitle">Join the Likhayag organization</p>
  </header>

  <div id="flashContainer" aria-live="polite" style="min-height:0;margin-bottom:6px"></div>

  <form id="signupForm" class="form" method="POST" action="{{ url_for('signup') }}" novalidate>
    <input type="hidden" id="displayName" name="display_name" value="">

    <div class="name-grid">
      <div>
        <label for="firstName">First Name</label>
        <div class="input-wrap">
          <span class="left-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24"><path d="M12 12a5 5 0 10-5-5 5 5 0 005 5zm0 2c-5 0-9 2.5-9 6v1h18v-1c0-3.5-4-6-9-6z"/></svg>
          </span>
          <input id="firstName" name="first_name" class="input" placeholder="John" required autocomplete="given-name">
        </div>
        <div id="firstNameError" class="error-text">First name is required and must not contain numbers</div>
      </div>

      <div>
        <label for="lastName">Last Name</label>
        <div class="input-wrap">
          <span class="left-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24"><path d="M12 12a5 5 0 10-5-5 5 5 0 005 5zm0 2c-5 0-9 2.5-9 6v1h18v-1c0-3.5-4-6-9-6z"/></svg>
          </span>
          <input id="lastName" name="last_name" class="input" placeholder="Doe" required autocomplete="family-name">
        </div>
        <div id="lastNameError" class="error-text">Last name is required and must not contain numbers</div>
      </div>

      <div style="grid-column:1 / -1; display:flex; gap:10px; align-items:center;">
        <button type="button" id="toggleExtrasBtn" class="toggle-extras">Add middle / suffix</button>
        <div id="displayNamePreview" class="preview" aria-live="polite">Preview: —</div>
      </div>

      <div id="nameExtras" style="grid-column:1 / -1; display:none; gap:10px;">
        <div>
          <label for="middleName">Middle Name <span style="font-weight:400;font-size:.85rem;color:var(--muted)">(optional)</span></label>
          <input id="middleName" name="middle_name" class="input" placeholder="A.">
        </div>
        <div>
          <label for="suffix">Suffix <span style="font-weight:400;font-size:.85rem;color:var(--muted)">(optional)</span></label>
          <input id="suffix" name="suffix" class="input" placeholder="Jr., Sr., III">
        </div>
      </div>
    </div>

    <!-- Email -->
    <div>
      <label for="email">Email</label>
      <div class="input-wrap">
        <span class="left-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M3 6.5C3 5.1 4.1 4 5.5 4h13c1.4 0 2.5 1.1 2.5 2.5v11c0 1.4-1.1 2.5-2.5 2.5h-13C4.1 20 3 18.9 3 17.5v-11zM5 7.5l7 5 7-5"/></svg>
        </span>
        <input id="email" name="email" type="email" class="input" placeholder="student@gmail.com" required autocomplete="email" aria-describedby="emailError">
      </div>
      <div id="emailError" class="error-text">Email must end with @gmail.com</div>
    </div>

    <!-- Password -->
    <div>
      <label for="password">Password</label>
      <div class="input-wrap">
        <span class="left-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M6 10V7a6 6 0 0 1 12 0v3h1a1 1 0 0 1 1 1v9a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-9a1 1 0 0 1 1-1h1zm3 0h6V7a3 3 0 0 0-6 0v3z"/></svg>
        </span>
        <input id="password" name="password" class="input" type="password" placeholder="Create a strong password" required aria-describedby="passwordError passwordStrengthDesc" autocomplete="new-password">
        <div class="right-icon">
          <button type="button" id="togglePassword" class="toggle-btn" aria-label="Show password" title="Show/hide password">
            <!-- outlined eye (initial) -->
            <svg id="eyeIcon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
          </button>
        </div>
      </div>

      <!-- password strength -->
      <div class="strength-wrap" aria-hidden="false">
        <div class="strength-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100">
          <div class="strength-fill" id="strengthFill"></div>
        </div>
        <div class="strength-text" id="strengthText" aria-live="polite">—</div>
      </div>

      <div id="passwordError" class="error-text">Password must be at least 8 characters and include a number and a special character.</div>
      <div id="passwordStrengthDesc" class="hint">Min 8 chars, include a number & a special character.</div>
    </div>

    <!-- Confirm Password -->
    <div>
      <label for="confirmPassword">Confirm Password</label>
      <div class="input-wrap">
        <input id="confirmPassword" name="confirmPassword" class="input" type="password" placeholder="Confirm your password" required autocomplete="new-password">
        <div class="right-icon">
          <button type="button" id="toggleConfirmPassword" class="toggle-btn" aria-label="Show confirm password" title="Show/hide confirm password">
            <svg id="eyeConfirmIcon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
          </button>
        </div>
      </div>
      <div id="confirmPasswordError" class="error-text">Passwords do not match</div>
    </div>

    <!-- 2FA Code -->
    <div>
      <label for="twoFACode">2FA Code</label>
      <div class="twofa-row">
        <input id="twoFACode" name="two_fa_code" class="twofa-input" placeholder="Enter the 16-character verification code" maxlength="32" aria-describedby="twoFACodeError">
        <button type="button" id="sendCodeBtn" class="btn btn-gold">Send code</button>
      </div>
      <div id="twoFACodeError" class="error-text">Invalid 2FA code</div>
      <div class="hint">Click <strong>Send code</strong> to receive a 16-character code to your Gmail, then copy & paste it here.</div>
    </div>

    <div style="margin-top:8px">
      <button id="createBtn" type="submit" class="btn btn-gold" style="width:100%;">Create Account</button>
    </div>

    <div class="divider"><span>or</span></div>
    <div class="footer">Already have an account? <a href="{{ url_for('login') }}" style="color:var(--accent);font-weight:700">Sign in</a></div>
  </form>
</main>

<!-- smaller 2FA modal with fade+scale -->
<div id="twoFAModal" class="modal-overlay" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="twoFATitle">
    <div class="modal-title" id="twoFATitle">Two-step verification</div>
    <div class="modal-desc" id="twoFAMsg">We've sent a verification code to your email. Paste the 16-character code here.</div>

    <input id="otpInput" class="modal-input" type="text" maxlength="32" placeholder="Paste the 16-character code here" />

    <div class="modal-actions">
      <button id="modalCancel" class="btn btn-ghost">Cancel</button>
      <button id="modalVerify" class="btn btn-gold">Verify</button>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
      <div class="hint">Didn't get a code? <button id="modalResend" class="toggle-extras" style="background:none;border:0;padding:0">Resend</button></div>
      <div class="hint">Expires in <span id="otpTimer">03:00</span></div>
    </div>

    <div id="modalMsg" class="modal-msg" style="display:none"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  // elements
  const firstName = document.getElementById('firstName');
  const middleName = document.getElementById('middleName');
  const lastName = document.getElementById('lastName');
  const suffix = document.getElementById('suffix');
  const displayNamePreview = document.getElementById('displayNamePreview');

  const toggleExtrasBtn = document.getElementById('toggleExtrasBtn');
  const nameExtras = document.getElementById('nameExtras');

  const email = document.getElementById('email');
  const password = document.getElementById('password');
  const confirmPassword = document.getElementById('confirmPassword');

  const sendCodeBtn = document.getElementById('sendCodeBtn');
  const createBtn = document.getElementById('createBtn');

  const togglePassword = document.getElementById('togglePassword');
  const eyeIcon = document.getElementById('eyeIcon');
  const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
  const eyeConfirmIcon = document.getElementById('eyeConfirmIcon');

  const passwordError = document.getElementById('passwordError');
  const confirmPasswordError = document.getElementById('confirmPasswordError');
  const firstNameError = document.getElementById('firstNameError');
  const lastNameError = document.getElementById('lastNameError');
  const emailError = document.getElementById('emailError');

  const strengthFill = document.getElementById('strengthFill');
  const strengthText = document.getElementById('strengthText');

  // modal
  const twoFAModal = document.getElementById('twoFAModal');
  const modalVerify = document.getElementById('modalVerify');
  const modalCancel = document.getElementById('modalCancel');
  const modalResend = document.getElementById('modalResend');
  const otpInput = document.getElementById('otpInput');
  const otpTimer = document.getElementById('otpTimer');
  const modalMsg = document.getElementById('modalMsg');

  // helper: compose display name
  function normalizeNamePart(s){ return (s||'').trim().replace(/\s+/g,' ').replace(/[^\w.\-' ]/g,''); }
  function buildDisplayName(){
    const f = normalizeNamePart(firstName.value);
    const m = normalizeNamePart(middleName.value);
    const l = normalizeNamePart(lastName.value);
    const s = normalizeNamePart(suffix.value);
    let out = f || '';
    if(m) out += (out ? ' ' : '') + m;
    if(l) out += (out ? ' ' : '') + l;
    if(s) out += (s ? ', ' + s : '');
    return out || '—';
  }
  function updatePreview(){ displayNamePreview.textContent = 'Preview: ' + buildDisplayName(); }
  [firstName, middleName, lastName, suffix].forEach(i => i.addEventListener('input', updatePreview));
  updatePreview();

  // enforce no digits in names
  function containsDigits(s){ return /\d/.test(s); }
  [firstName, middleName, lastName, suffix].forEach(el => {
    el.addEventListener('input', () => {
      const id = el.id;
      const errEl = (id === 'firstName') ? firstNameError : (id === 'lastName') ? lastNameError : null;
      if(containsDigits(el.value)){
        if(errEl) { errEl.textContent = (errEl.id==='firstNameError' || errEl.id==='lastNameError') ? `${errEl.id==='firstNameError' ? 'First' : 'Last'} name must not contain numbers` : ''; errEl.style.display = 'block'; }
        el.classList.add('error');
      } else {
        if(errEl) errEl.style.display = 'none';
        el.classList.remove('error');
      }
      updatePreview();
    });
  });

  // toggle extras
  toggleExtrasBtn.addEventListener('click', () => {
    const showing = nameExtras.style.display === 'grid';
    nameExtras.style.display = showing ? 'none' : 'grid';
    toggleExtrasBtn.textContent = showing ? 'Add middle / suffix' : 'Hide middle / suffix';
    updatePreview();
  });

  // keep input text color consistent after toggling
  function reapplyInputColor(){
    document.querySelectorAll('.input').forEach(i => {
      i.style.color = getComputedStyle(document.documentElement).getPropertyValue('--input-text').trim();
      i.style.webkitTextFillColor = getComputedStyle(document.documentElement).getPropertyValue('--input-text').trim();
    });
  }

  // outlined eye toggle handlers (we replace inner paths only)
  togglePassword.addEventListener('click', () => {
    if(password.type === 'password'){
      password.type = 'text';
      togglePassword.setAttribute('aria-label','Hide password');
      // eye-off outlined: combine slash + partial paths to represent "closed"
      eyeIcon.innerHTML =
        '<path d="M3 3l18 18"></path>' +
        '<path d="M9.88 9.88a3 3 0 104.24 4.24"></path>' +
        '<path d="M2.46 12C3.73 7.94 7.52 5 12 5c1.63 0 3.14.37 4.5 1.03"></path>';
    } else {
      password.type = 'password';
      togglePassword.setAttribute('aria-label','Show password');
      // eye outlined (open)
      eyeIcon.innerHTML =
        '<path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>' +
        '<circle cx="12" cy="12" r="3"></circle>';
    }
    setTimeout(reapplyInputColor, 0);
  });

  toggleConfirmPassword.addEventListener('click', () => {
    if(confirmPassword.type === 'password'){
      confirmPassword.type = 'text';
      toggleConfirmPassword.setAttribute('aria-label','Hide confirm password');
      eyeConfirmIcon.innerHTML =
        '<path d="M3 3l18 18"></path>' +
        '<path d="M9.88 9.88a3 3 0 104.24 4.24"></path>' +
        '<path d="M2.46 12C3.73 7.94 7.52 5 12 5c1.63 0 3.14.37 4.5 1.03"></path>';
    } else {
      confirmPassword.type = 'password';
      toggleConfirmPassword.setAttribute('aria-label','Show confirm password');
      eyeConfirmIcon.innerHTML =
        '<path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>' +
        '<circle cx="12" cy="12" r="3"></circle>';
    }
    setTimeout(reapplyInputColor, 0);
  });

  // password strength scoring
  function assessPassword(str){
    let score = 0;
    if(!str) return {score:0,label:'—',pct:0,color:'#f97316'};
    if(str.length >= 8) score += 1;
    if(/[A-Z]/.test(str) && /[a-z]/.test(str)) score += 1;
    if(/\d/.test(str)) score += 1;
    if(/[!@#$%^&*()_\-+={[}\]|\\:;"'<>,.?/]/.test(str)) score += 1;
    if(score <= 1) return {score,label:'Weak',pct:25,color:'#f97316'};
    if(score === 2) return {score,label:'Fair',pct:50,color:'#f59e0b'};
    if(score === 3) return {score,label:'Good',pct:75,color:'#10b981'};
    return {score,label:'Strong',pct:100,color:'#059669'};
  }

  password.addEventListener('input', () => {
    const val = password.value || '';
    const r = assessPassword(val);
    const fill = document.getElementById('strengthFill');
    fill.style.width = (r.pct||0) + '%';
    fill.style.background = r.color || '#f97316';
    strengthText.textContent = r.label || '—';
    reapplyInputColor();
  });

  // modal utilities (compact)
  let otpInterval = null;
  function showModal(message){
    document.getElementById('twoFAMsg').textContent = message || 'We sent a verification code to your email.';
    twoFAModal.classList.add('show');
    twoFAModal.setAttribute('aria-hidden','false');
    otpInput.value = ''; otpInput.disabled = false; modalMsg.style.display = 'none';
    startOtpTimer(180);
    setTimeout(()=> otpInput.focus(), 200);
  }
  function closeModal(){
    twoFAModal.classList.remove('show');
    twoFAModal.setAttribute('aria-hidden','true');
    stopOtpTimer();
  }
  function startOtpTimer(seconds){
    stopOtpTimer();
    let s = seconds;
    function tick(){ if(s<=0){ otpTimer.textContent='00:00'; stopOtpTimer(); otpInput.disabled=true; } else { otpTimer.textContent = formatTime(s); s--; } }
    tick(); otpInterval = setInterval(tick,1000);
  }
  function stopOtpTimer(){ if(otpInterval) clearInterval(otpInterval); otpInterval = null; }
  function formatTime(sec){ const m = Math.floor(sec/60); const s = sec%60; return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0'); }

  // small flash helper
  function showFlash(msg, type='error'){
    const container = document.getElementById('flashContainer');
    container.innerHTML = '';
    const d = document.createElement('div');
    d.style.padding='8px'; d.style.margin='6px'; d.style.borderRadius='8px'; d.style.fontWeight='700';
    d.textContent = msg;
    if(type==='error'){ d.style.background='#fee2e2'; d.style.color = 'var(--err)'; d.style.border = '1px solid #fecaca'; }
    else { d.style.background='#d1fae5'; d.style.color='#065f46'; d.style.border='1px solid #a7f3d0'; }
    container.appendChild(d);
    setTimeout(()=> { if(d.parentNode) d.parentNode.removeChild(d); }, 5000);
  }

  // Send code
  sendCodeBtn.addEventListener('click', async function(){
    const em = (email.value || '').trim();
    if(!em || !em.endsWith('@gmail.com')){ emailError.style.display = 'block'; email.classList.add('error'); showFlash('Enter a valid Gmail address before sending code','error'); return; }
    emailError.style.display = 'none'; email.classList.remove('error');

    const prev = sendCodeBtn.innerHTML;
    sendCodeBtn.disabled = true;
    sendCodeBtn.innerHTML = 'Sending...';
    try{
      const res = await fetch('/api/2fa/send', { method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email: em }) });
      const data = await res.json().catch(()=>({}));
      if(!res.ok){ showFlash(data.message || 'Failed to send code','error'); }
      else { showFlash(data.message || 'Verification code sent — check your inbox','success'); showModal(data.message || 'We sent a verification code to your email.'); }
    } catch(err){
      console.error('send code error', err); showFlash('Network error sending code','error');
    } finally { sendCodeBtn.disabled = false; sendCodeBtn.innerHTML = prev; }
  });

  // modal verify (compact)
  modalVerify.addEventListener('click', async function(){
    modalMsg.style.display = 'none';
    const code = (otpInput.value || '').trim();
    if(!code){ modalMsg.textContent = 'Please enter the verification code'; modalMsg.style.display='block'; return; }
    modalVerify.disabled = true; const prev = modalVerify.innerHTML; modalVerify.innerHTML = 'Verifying...';
    try{
      const payload = { email: email.value.trim(), code: code };
      const res = await fetch('/api/2fa/verify', { method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const data = await res.json().catch(()=>({}));
      if(!res.ok){ modalMsg.textContent = data.message || 'Verification failed'; modalMsg.style.display='block'; }
      else { modalMsg.textContent = data.message || 'Verified — redirecting'; modalMsg.style.display='block'; setTimeout(()=> window.location.href = data.redirect_url || '/home', 750); }
    } catch(err){ console.error(err); modalMsg.textContent = 'Network error verifying code'; modalMsg.style.display='block'; }
    modalVerify.disabled = false; modalVerify.innerHTML = prev;
  });

  modalCancel.addEventListener('click', ()=>{ closeModal(); showFlash('Two-step verification cancelled','error'); });
  modalResend.addEventListener('click', async ()=>{
    const em = (email.value || '').trim();
    if(!em){ showFlash('Enter your email first','error'); return; }
    modalResend.disabled = true;
    try{
      const res = await fetch('/api/2fa/resend', { method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email: em }) });
      const data = await res.json().catch(()=>({}));
      if(!res.ok) showFlash(data.message || 'Failed to resend code','error'); else { showFlash(data.message || 'Code resent','success'); startOtpTimer(180); otpInput.disabled=false; otpInput.focus(); }
    } catch(err){ console.error(err); showFlash('Network error while resending','error'); }
    modalResend.disabled = false;
  });

  // submit form
  document.getElementById('signupForm').addEventListener('submit', async function(e){
    e.preventDefault();
    document.querySelectorAll('.error-text').forEach(x => x.style.display='none');
    document.querySelectorAll('.input').forEach(x => x.classList.remove('error'));

    let ok = true;
    if(!firstName.value.trim() || containsDigits(firstName.value)){ firstNameError.style.display='block'; firstName.classList.add('error'); ok=false; }
    if(!lastName.value.trim() || containsDigits(lastName.value)){ lastNameError.style.display='block'; lastName.classList.add('error'); ok=false; }
    const em = (email.value||'').trim();
    if(!em || !em.endsWith('@gmail.com')){ emailError.style.display='block'; email.classList.add('error'); ok=false; }

    const pw = password.value || '';
    const pwInfo = assessPassword(pw);
    if(!(pwInfo.score >= 3)){ passwordError.style.display='block'; password.classList.add('error'); ok=false; }
    if(confirmPassword.value !== pw){ confirmPasswordError.style.display='block'; confirmPassword.classList.add('error'); ok=false; }

    if(!ok){ showFlash('Please fix the errors and try again','error'); return; }

    const payload = {
      first_name: firstName.value.trim(),
      middle_name: middleName.value.trim(),
      last_name: lastName.value.trim(),
      suffix: suffix.value.trim(),
      email: em,
      password: pw,
      confirmPassword: confirmPassword.value
    };

    createBtn.disabled = true;
    const prevCreate = createBtn.innerHTML;
    createBtn.innerHTML = 'Creating...';
    try{
      const res = await fetch('/api/signup', { method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const data = await res.json().catch(()=>({}));
      if(!res.ok){
        if(data && data.field_errors){
          for(const k in data.field_errors){
            const map = { first_name:'firstNameError', last_name:'lastNameError', email:'emailError', password:'passwordError', confirmPassword:'confirmPasswordError' };
            if(map[k]){ const el = document.getElementById(map[k]); el.textContent = data.field_errors[k]; el.style.display='block'; const input = document.getElementById(map[k].replace('Error','')); if(input) input.classList.add('error'); }
          }
        }
        showFlash(data && data.message ? data.message : 'Signup failed. Please try again.', 'error');
      } else {
        showFlash('Account created. Sending verification code...', 'success');
        try{
          const sendRes = await fetch('/api/2fa/send', { method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email: em, user_id: data && data.user_id }) });
          const sendJson = await sendRes.json().catch(()=>({}));
          if(!sendRes.ok){ showFlash(sendJson.message || 'Failed to send verification code. Request manually.', 'error'); } else { showModal(sendJson.message || 'Verification code sent.'); }
        } catch(err){ console.error(err); showFlash('Network error sending verification code', 'error'); }
      }
    } catch(err){ console.error(err); showFlash('Network error creating account', 'error'); }
    finally{ createBtn.disabled = false; createBtn.innerHTML = prevCreate; }
  });

  // helpers
  function containsDigits(s){ return /\d/.test(s); }
  function assessPassword(str){
    let score = 0;
    if(!str) return {score:0,label:'—',pct:0,color:'#f97316'};
    if(str.length >= 8) score++;
    if(/[A-Z]/.test(str) && /[a-z]/.test(str)) score++;
    if(/\d/.test(str)) score++;
    if(/[!@#$%^&*()_\-+={[}\]|\\:;"'<>,.?/]/.test(str)) score++;
    if(score <= 1) return {score,label:'Weak',pct:25,color:'#f97316'};
    if(score === 2) return {score,label:'Fair',pct:50,color:'#f59e0b'};
    if(score === 3) return {score,label:'Good',pct:75,color:'#10b981'};
    return {score,label:'Strong',pct:100,color:'#059669'};
  }
});
</script>
</body>
</html>
